# Agent Governance & Environment Control

The **Adam Financial Intelligence System** implements a strict governance model to ensure safety, compliance, and auditability of autonomous agents. This document details the architectural components enforcing these rules.

## 1. The Constitution

At the core of every agent's decision-making process is the **Constitution**. Defined in `core/governance/constitution.py`, it serves as the supreme law that agents cannot override.

### Core Principles
1.  **DO_NO_HARM (Weight: 10.0)**: Agents must not take actions that could cause financial ruin or systemic risk.
2.  **COMPLIANCE (Weight: 8.0)**: Agents must adhere to regulatory frameworks (SEC, GDPR, etc.).
3.  **RISK_MANAGEMENT (Weight: 7.0)**: Agents must maintain risk exposure within defined limits (e.g., VaR thresholds).
4.  **TRANSPARENCY (Weight: 5.0)**: All actions must be explainable and logged.

### Implementation
The `Constitution` class provides a `check_action` method that validates proposed actions against these principles.

```python
from core.governance.constitution import Constitution

constitution = Constitution()
allowed = constitution.check_action("EXECUTE_TRADE", {"risk_score": 0.2})
```

## 2. Environment Control (The Gatekeeper)

To prevent untested code or models from reaching production, we use the **EnvironmentGate** (`core/governance/environment_control.py`).

### Environments
- **DEV**: Development sandbox. No time locks. Requires 1 Operator approval.
- **QA**: Quality Assurance. No time locks.
- **STAGING**: Pre-production. 5-minute time lock. Requires Manager approval.
- **PROD**: Production. 1-hour time lock. Requires 2 Director approvals.
- **DR**: Disaster Recovery. Immediate access. Requires CISO approval.

### Deployment Lifecycle
1.  **DRAFT**: A deployment request is created.
2.  **PENDING_APPROVAL**: The request is submitted to the `ApprovalTool`.
3.  **APPROVED / REJECTED**: Stakeholders sign off.
4.  **TIME_LOCKED**: If approved, a mandatory cooling-off period applies (PROD/STAGING).
5.  **DEPLOYED**: Once the lock expires, a deployment token is issued.

## 3. Approval Tool (Human-in-the-Loop)

The `ApprovalTool` (`core/adk_patterns/approval_tool.py`) manages the human sign-off process.

- **Quorum Policies**: Defines who must sign. E.g., "2 Directors and 1 CISO".
- **Risk Assessment**: Automatically calculates risk scores to determine the required policy.
- **Digital Signatures**: All approvals are cryptographically signed (mocked for now) and audit-logged.

## 4. Middleware Enforcement

The `GovernanceMiddleware` (`services/webapp/governance.py`) sits at the API edge.

- **Endpoint Protection**: Blocks high-risk endpoints (e.g., `/api/trade`) unless a valid **Governance Override Token** is provided.
- **Keyword Scanning**: Scans payloads for dangerous keywords (e.g., `DROP TABLE`).
- **Sentinel Overrides**: Allows authorized personnel to bypass blocks using a signed token generated by the `ApprovalTool`.

## 5. Integration Workflow

1.  **Agent proposes an action** (e.g., "Update Model").
2.  **Constitution checks** the action for safety.
3.  If it involves deployment, **EnvironmentGate** is invoked.
4.  **Human approvers** receive a notification and sign off via the `ApprovalTool`.
5.  Upon consensus, an **Override Token** is issued.
6.  The Agent uses this token to call the protected API via **GovernanceMiddleware**.

---
*This governance model ensures that while agents are autonomous, they operate within strict, verifiable safety bounds.*
