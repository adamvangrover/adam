<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM | DCF Valuator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-dark: #020408;
            --panel-glass: rgba(10, 15, 30, 0.7);
            --cyan-glow: #00f0ff;
            --purple-glow: #a855f7;
            --grid-line: rgba(0, 240, 255, 0.05);
        }

        body {
            background-color: var(--bg-dark);
            color: #e2e8f0;
            font-family: 'Courier New', Courier, monospace;
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 30px 30px;
            overflow: hidden;
        }

        .glass-panel {
            background: var(--panel-glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 240, 255, 0.1);
            transition: border-color 0.3s ease;
        }
        .glass-panel:hover {
            border-color: rgba(0, 240, 255, 0.3);
        }

        /* Input Styling */
        input[type="number"], select {
            background: #050a14;
            border: 1px solid #1e293b;
            color: var(--cyan-glow);
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }
        input[type="number"]:focus, select:focus {
            border-color: var(--cyan-glow);
            box-shadow: 0 0 8px rgba(0, 240, 255, 0.3);
            outline: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--cyan-glow); }

        /* Tables */
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th { background: rgba(0, 240, 255, 0.05); color: var(--cyan-glow); font-weight: normal; text-transform: uppercase; letter-spacing: 1px; }
        td { border-bottom: 1px solid #1e293b; padding: 4px; }

        /* Sensitivity Table */
        .sens-cell { text-align: center; font-size: 0.7rem; cursor: crosshair; }
        .sens-header { font-weight: bold; color: #94a3b8; }
        .sens-highlight { background: rgba(0, 240, 255, 0.15); font-weight: bold; color: white; border: 1px solid var(--cyan-glow); }
        .sens-over { color: #4ade80; background: rgba(74, 222, 128, 0.05); } /* Green tint */
        .sens-under { color: #f87171; background: rgba(248, 113, 113, 0.05); } /* Red tint */

        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }

        /* Print Styles */
        @media print {
            body { background: white; color: black; overflow: visible; }
            .glass-panel { border: 1px solid #ccc; backdrop-filter: none; background: white; box-shadow: none; }
            button, select { display: none; }
            canvas { max-height: 300px; }
            aside { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
            main { width: 100%; }
            .grid-cols-12 { display: block; }
            h1, h2, h3 { color: black !important; }
            * { text-shadow: none !important; box-shadow: none !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col p-4 text-xs">

    <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2 flex-shrink-0">
        <h1 class="text-lg font-bold text-white tracking-widest flex items-center group cursor-default">
            <i data-lucide="bar-chart-2" class="w-5 h-5 mr-2 text-cyan-400 group-hover:text-cyan-200 transition-colors"></i>
            DCF VALUATOR <span class="text-[10px] ml-2 px-2 py-0.5 border border-cyan-500/50 rounded text-cyan-300 shadow-[0_0_10px_rgba(0,240,255,0.3)]">PRO</span>
        </h1>
        <div class="flex gap-2">
            <div class="flex items-center gap-2 mr-4 bg-gray-900/50 px-2 rounded border border-gray-800">
                <span class="text-[10px] text-gray-400 uppercase font-semibold"><i data-lucide="layers" class="inline w-3 h-3 mr-1"></i>Scenario:</span>
                <select id="scenario" onchange="app.runModel()" class="bg-transparent border-none text-white focus:ring-0 py-1">
                    <option value="base">Base Case</option>
                    <option value="bull">Bull Case (+20%)</option>
                    <option value="bear">Bear Case (-20%)</option>
                </select>
            </div>
            
            <button onclick="app.runMonteCarlo()" class="px-3 py-1 bg-purple-900/20 border border-purple-500/30 text-purple-400 rounded hover:bg-purple-500/30 hover:text-white transition-all text-[10px] font-bold flex items-center gap-1 mr-1">
                <i data-lucide="dices" class="w-3 h-3"></i> SIMULATE
            </button>
            
            <button onclick="app.exportCSV()" class="px-3 py-1 bg-cyan-900/20 border border-cyan-500/30 text-cyan-400 rounded hover:bg-cyan-500/30 hover:text-white transition-all text-[10px] font-bold flex items-center gap-1">
                <i data-lucide="download" class="w-3 h-3"></i> CSV
            </button>

            <button onclick="window.print()" class="px-3 py-1 bg-gray-800 border border-gray-700 text-gray-400 rounded hover:bg-gray-700 hover:text-white transition-all text-[10px] font-bold flex items-center gap-1 ml-1">
                <i data-lucide="printer" class="w-3 h-3"></i>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-12 gap-4 flex-grow overflow-hidden">
        
        <aside class="col-span-3 space-y-3 overflow-y-auto pr-2 custom-scroll pb-10">

            <div class="glass-panel p-3 rounded">
                <div class="text-[10px] text-gray-500 mb-2 uppercase font-bold flex justify-between items-center">
                    <span>1. Historicals ($M)</span>
                    <i data-lucide="history" class="w-3 h-3 text-cyan-500/50"></i>
                </div>
                <div class="space-y-2">
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">LTM Revenue</label>
                        <input type="number" id="ltmRev" value="1000" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">LTM EBITDA</label>
                        <input type="number" id="ltmEbitda" value="250" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                    </div>
                </div>
            </div>

            <div class="glass-panel p-3 rounded">
                <div class="text-[10px] text-gray-500 mb-2 uppercase font-bold flex justify-between items-center">
                    <span>2. Cost of Capital</span>
                    <i data-lucide="settings-2" class="w-3 h-3 text-cyan-500/50"></i>
                </div>
                <div class="grid grid-cols-1 gap-2">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-gray-400 text-[10px] mb-1" title="Risk Free Rate">Rf Rate (%)</label>
                            <input type="number" id="rfRate" value="4.0" step="0.1" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                        </div>
                        <div>
                            <label class="block text-gray-400 text-[10px] mb-1" title="Market Risk Premium">MRP (%)</label>
                            <input type="number" id="mrp" value="6.0" step="0.1" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Beta (Levered)</label>
                        <input type="number" id="beta" value="1.1" step="0.05" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                             <label class="block text-gray-400 text-[10px] mb-1">Cost Debt %</label>
                             <input type="number" id="costDebt" value="6.5" step="0.1" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                        </div>
                        <div>
                            <label class="block text-gray-400 text-[10px] mb-1">Tax Rate %</label>
                            <input type="number" id="taxRate" value="21.0" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Debt / Total Cap (%)</label>
                        <input type="number" id="debtWeight" value="30.0" step="1" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                    </div>
                    
                    <div class="border-t border-gray-700 pt-2 mt-1">
                        <label class="block text-gray-400 text-[10px] mb-1 text-cyan-300 font-bold">Terminal Growth (%)</label>
                        <input type="number" id="tgr" value="2.5" step="0.1" class="w-full px-2 py-1 rounded border-cyan-500/30 bg-cyan-900/10" onchange="app.runModel()">
                    </div>
                </div>
            </div>

            <div class="glass-panel p-3 rounded">
                <div class="text-[10px] text-gray-500 mb-2 uppercase font-bold flex justify-between items-center">
                    <span>3. Projections</span>
                    <i data-lucide="trending-up" class="w-3 h-3 text-cyan-500/50"></i>
                </div>
                <div class="space-y-2">
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Rev Growth % (Avg)</label>
                        <input type="number" id="avgGrowth" value="5.0" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">EBITDA Margin % (Avg)</label>
                        <input type="number" id="avgMargin" value="25.0" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Capex % Rev</label>
                        <input type="number" id="capexPct" value="3.0" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                    </div>
                </div>
            </div>

            <div class="glass-panel p-3 rounded">
                <div class="text-[10px] text-gray-500 mb-2 uppercase font-bold flex justify-between items-center">
                    <span>4. Capital Structure</span>
                    <i data-lucide="pie-chart" class="w-3 h-3 text-cyan-500/50"></i>
                </div>
                <div class="space-y-2">
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Net Debt ($M)</label>
                        <input type="number" id="netDebt" value="500" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-[10px] mb-1">Shares Out (M)</label>
                        <input type="number" id="shares" value="100" class="w-full px-2 py-1 rounded" onchange="app.runModel()">
                    </div>
                </div>
            </div>

        </aside>

        <main class="col-span-9 flex flex-col gap-3 overflow-y-auto pr-2 custom-scroll pb-10">

            <div class="grid grid-cols-4 gap-3">
                <div class="glass-panel p-2 rounded flex flex-col justify-center">
                    <div class="text-[9px] text-gray-500 uppercase tracking-wider">Enterprise Value</div>
                    <div class="text-lg font-bold text-white mt-1 font-mono tracking-tight" id="val-ev">$0.0M</div>
                </div>
                <div class="glass-panel p-2 rounded flex flex-col justify-center">
                    <div class="text-[9px] text-gray-500 uppercase tracking-wider">Equity Value</div>
                    <div class="text-lg font-bold text-white mt-1 font-mono tracking-tight" id="val-eq">$0.0M</div>
                </div>
                <div class="glass-panel p-2 rounded border-cyan-500/30 bg-cyan-900/10 flex flex-col justify-center relative overflow-hidden">
                    <div class="absolute -right-2 -top-2 w-10 h-10 bg-cyan-500/20 blur-xl rounded-full"></div>
                    <div class="text-[9px] text-cyan-400 uppercase font-bold tracking-wider z-10">Implied Share Price</div>
                    <div class="text-2xl font-bold text-cyan-300 mt-1 font-mono tracking-tight z-10" id="val-share">$0.00</div>
                </div>
                <div class="glass-panel p-2 rounded flex flex-col justify-center">
                    <div class="text-[9px] text-gray-500 uppercase tracking-wider">WACC</div>
                    <div class="text-lg font-bold text-white mt-1 font-mono tracking-tight" id="val-wacc">0.0%</div>
                </div>
            </div>

            <div class="glass-panel p-3 rounded">
                <h3 class="text-xs font-bold text-cyan-400 mb-2 flex items-center gap-2">
                    <i data-lucide="table" class="w-3 h-3"></i> Unlevered Free Cash Flow Build
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-xs font-mono">
                        <thead>
                            <tr class="text-gray-500 border-b border-gray-700">
                                <th class="text-left py-1 pl-2">Metric</th>
                                <th class="text-right">Y1</th><th class="text-right">Y2</th><th class="text-right">Y3</th><th class="text-right">Y4</th><th class="text-right pr-2">Y5</th>
                            </tr>
                        </thead>
                        <tbody id="dcf-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 h-64">
                <div class="glass-panel p-3 rounded overflow-hidden flex flex-col">
                    <h3 class="text-xs font-bold text-gray-400 mb-2 flex items-center gap-2">
                        <i data-lucide="grid" class="w-3 h-3"></i> Sensitivity Analysis
                        <span class="text-[9px] text-gray-600 ml-auto font-mono">(Vertical: TGR | Horizontal: WACC)</span>
                    </h3>
                    <div class="flex-grow flex justify-center items-center">
                        <div id="sensitivity-container" class="w-full h-full flex items-center justify-center">
                            </div>
                    </div>
                </div>

                <div class="glass-panel p-3 rounded relative">
                     <canvas id="chart-dcf"></canvas>
                </div>
            </div>

            <div id="mc-panel" class="glass-panel p-3 rounded hidden animate-fade-in border-purple-500/20">
                <div class="flex justify-between items-center mb-2 border-b border-gray-800 pb-2">
                    <h3 class="text-xs font-bold text-purple-400 flex items-center gap-2">
                        <i data-lucide="scatter-chart" class="w-3 h-3"></i> Monte Carlo Distribution (N=1,000)
                    </h3>
                    <div class="text-[9px] text-gray-400 font-mono flex gap-4">
                        <span id="mc-stats-mean">Mean: --</span>
                        <span id="mc-stats-vol">Vol: --</span>
                    </div>
                </div>
                <div class="h-48 w-full relative">
                    <canvas id="chart-mc"></canvas>
                </div>
                <div class="flex justify-between text-[9px] text-gray-500 mt-2 font-mono px-4">
                    <div class="text-left">
                        <div class="text-red-400 font-bold">Bear Case (5th %ile)</div>
                        <div id="mc-p05" class="text-lg text-white">$0.00</div>
                    </div>
                     <div class="text-center">
                        <div class="text-purple-400 font-bold">Median (50th %ile)</div>
                        <div id="mc-median" class="text-lg text-white">$0.00</div>
                    </div>
                     <div class="text-right">
                        <div class="text-green-400 font-bold">Bull Case (95th %ile)</div>
                        <div id="mc-p95" class="text-lg text-white">$0.00</div>
                    </div>
                </div>
            </div>
            
            <footer class="text-[9px] text-gray-700 text-center mt-4 pb-2">
                ADAM FINANCIAL SYSTEMS | STANDALONE MODULE v2.1
            </footer>

        </main>
    </div>

    <script>
        /**
         * ADAM Stochastic Engine
         * Handles probability distributions and simulation logic
         */
        class StochasticEngine {
            // Box-Muller transform for normal distribution
            static randomNormal(mean, stdDev) {
                let u = 0, v = 0;
                while(u === 0) u = Math.random();
                while(v === 0) v = Math.random();
                const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                return mean + (z * stdDev);
            }

            static runSimulation(baseInputs, currentWacc, iterations = 1000) {
                const results = [];
                
                // Simulation Parameters
                const growthVol = 0.02; // +/- 2% std dev
                const marginVol = 0.03; // +/- 3% std dev
                const waccVol   = 0.005; // +/- 0.5% std dev

                for(let i=0; i<iterations; i++) {
                    // Shock the inputs using random walk
                    const shockedInputs = {
                        ...baseInputs,
                        avgGrowth: this.randomNormal(baseInputs.avgGrowth, growthVol),
                        avgMargin: this.randomNormal(baseInputs.avgMargin, marginVol)
                    };

                    // Shock WACC
                    const shockedWacc = this.randomNormal(currentWacc, waccVol);
                    
                    // Fixed TGR for simulation to isolate operational/discount noise
                    const shockedTgr = 0.025; 

                    const res = app.calculateDCF(shockedWacc, shockedTgr, shockedInputs);
                    
                    // Calculate Implied Share Price
                    const netDebt = parseFloat(document.getElementById('netDebt').value);
                    const shares = parseFloat(document.getElementById('shares').value);
                    const eqVal = res.ev - netDebt;
                    const sharePrice = eqVal / shares;

                    results.push(sharePrice);
                }

                results.sort((a,b) => a-b);
                
                return {
                    min: results[0],
                    p05: results[Math.floor(iterations * 0.05)],
                    median: results[Math.floor(iterations * 0.5)],
                    mean: results.reduce((a,b)=>a+b, 0) / iterations,
                    p95: results[Math.floor(iterations * 0.95)],
                    max: results[iterations-1],
                    dataset: results
                };
            }
        }

        /**
         * Main Application Controller
         */
        const app = {
            chartInstance: null,
            mcChartInstance: null,
            lastProj: [],
            currentSharePrice: 0,
            currentWacc: 0,

            // Formatting Utilities
            fmtMoney: (n) => `$${n.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}`,
            fmtShare: (n) => `$${n.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
            fmtPct: (n) => `${(n*100).toFixed(1)}%`,
            getVal: (id) => parseFloat(document.getElementById(id).value) || 0,

            // Core Logic
            calculateDCF: function(waccInput, tgrInput, inputs) {
                let rev = inputs.ltmRev;
                let proj = [];

                for(let i=1; i<=5; i++) {
                    rev = rev * (1 + inputs.avgGrowth);
                    let ebitda = rev * inputs.avgMargin;
                    let da = ebitda * 0.15; // Assumption: D&A is 15% of EBITDA
                    let ebit = ebitda - da;
                    let tax = Math.max(0, ebit * inputs.taxRate);
                    let nopat = ebit - tax;
                    let capex = rev * inputs.capexPct;
                    let nwc = rev * 0.01; // 1% proxy
                    let ufcf = nopat + da - capex - nwc;

                    proj.push({ year: i, rev, ebitda, ufcf });
                }

                let pvFcf = 0;
                proj.forEach(p => {
                    pvFcf += p.ufcf / Math.pow(1 + waccInput, p.year);
                });

                // Terminal Value (Gordon Growth)
                const termFcf = proj[4].ufcf * (1 + tgrInput);
                const tv = termFcf / (waccInput - tgrInput);
                const pvTv = tv / Math.pow(1 + waccInput, 5);
                const ev = pvFcf + pvTv;

                return { ev, proj };
            },

            // Controller
            runModel: function() {
                // 1. Gather Inputs
                let ltmRev = this.getVal('ltmRev');
                let avgGrowth = this.getVal('avgGrowth') / 100;
                let avgMargin = this.getVal('avgMargin') / 100;
                let capexPct = this.getVal('capexPct') / 100;

                // Scenario Overrides
                const scenario = document.getElementById('scenario').value;
                if(scenario === 'bull') {
                    avgGrowth *= 1.2;
                    avgMargin *= 1.1;
                } else if (scenario === 'bear') {
                    avgGrowth *= 0.8;
                    avgMargin *= 0.9;
                }

                // WACC Calculation
                const rf = this.getVal('rfRate') / 100;
                const mrp = this.getVal('mrp') / 100;
                const beta = this.getVal('beta');
                const costDebt = this.getVal('costDebt') / 100;
                const debtWeight = this.getVal('debtWeight') / 100;
                const taxRate = this.getVal('taxRate') / 100;

                const ke = rf + (beta * mrp);
                const kd = costDebt * (1 - taxRate);
                const wacc = ((1 - debtWeight) * ke) + (debtWeight * kd);
                this.currentWacc = wacc;

                const tgr = this.getVal('tgr') / 100;
                const netDebt = this.getVal('netDebt');
                const shares = this.getVal('shares');

                const inputs = { ltmRev, avgGrowth, avgMargin, capexPct, taxRate };

                // 2. Execute Calculation
                const result = this.calculateDCF(wacc, tgr, inputs);
                const ev = result.ev;
                this.lastProj = result.proj;

                const eqVal = ev - netDebt;
                this.currentSharePrice = eqVal / shares;

                // 3. Update UI - KPIs
                document.getElementById('val-ev').innerText = this.fmtMoney(ev);
                document.getElementById('val-eq').innerText = this.fmtMoney(eqVal);
                document.getElementById('val-share').innerText = this.fmtShare(this.currentSharePrice);
                document.getElementById('val-wacc').innerText = this.fmtPct(wacc);

                // 4. Update UI - Table
                const tbody = document.getElementById('dcf-body');
                tbody.innerHTML = `
                    <tr><td class="pl-2 text-gray-500">Revenue</td>${this.lastProj.map(p=>`<td class="text-right text-gray-400">${this.fmtMoney(p.rev)}</td>`).join('')}</tr>
                    <tr><td class="pl-2 text-gray-500">EBITDA</td>${this.lastProj.map(p=>`<td class="text-right text-gray-300">${this.fmtMoney(p.ebitda)}</td>`).join('')}</tr>
                    <tr class="font-bold text-cyan-400 bg-cyan-900/10"><td class="pl-2">UFCF</td>${this.lastProj.map(p=>`<td class="text-right">${this.fmtMoney(p.ufcf)}</td>`).join('')}</tr>
                `;

                // 5. Update Components
                this.updateChart(this.lastProj);
                this.renderSensitivity(wacc, tgr, inputs, netDebt, shares);
            },

            updateChart: function(proj) {
                if(this.chartInstance) this.chartInstance.destroy();
                const ctx = document.getElementById('chart-dcf').getContext('2d');
                
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(0, 240, 255, 0.5)');
                gradient.addColorStop(1, 'rgba(0, 240, 255, 0)');

                this.chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Y1', 'Y2', 'Y3', 'Y4', 'Y5'],
                        datasets: [
                            {
                                label: 'UFCF',
                                data: proj.map(p=>p.ufcf),
                                borderColor: '#00f0ff',
                                borderWidth: 2,
                                backgroundColor: gradient,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'EBITDA',
                                data: proj.map(p=>p.ebitda),
                                borderColor: '#94a3b8',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                tension: 0.4,
                                pointRadius: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: {family: 'monospace', size: 10} } }, x: { grid: { display: false }, ticks: { color: '#64748b', font: {family: 'monospace'} } } },
                        plugins: { legend: { labels: { color: '#cbd5e1', font: {family: 'monospace', size: 10} } } }
                    }
                });
            },

            renderSensitivity: function(baseWacc, baseTgr, inputs, netDebt, shares) {
                const container = document.getElementById('sensitivity-container');
                let html = '<table class="w-full h-full border-collapse font-mono">';

                // Header Row
                html += '<tr><td class="sens-header text-right pr-2 text-[8px]">TGR\\WACC</td>';
                for(let c=-2; c<=2; c++) {
                    const w = baseWacc + (c * 0.005);
                    html += `<td class="sens-header sens-cell">${this.fmtPct(w)}</td>`;
                }
                html += '</tr>';

                // Data Rows
                for(let r=2; r>=-2; r--) {
                    const t = baseTgr + (r * 0.0025);
                    html += `<tr><td class="sens-header text-right pr-2">${this.fmtPct(t)}</td>`;

                    for(let c=-2; c<=2; c++) {
                        const w = baseWacc + (c * 0.005);
                        const res = this.calculateDCF(w, t, inputs);
                        const sp = (res.ev - netDebt) / shares;
                        const isCenter = (r===0 && c===0);
                        
                        // Color logic
                        let cls = '';
                        if(isCenter) cls = 'sens-highlight rounded shadow-md';
                        else if (sp > this.currentSharePrice) cls = 'sens-over';
                        else cls = 'sens-under';

                        html += `<td class="sens-cell ${cls} p-1" title="EV: ${this.fmtMoney(res.ev)}">${this.fmtShare(sp)}</td>`;
                    }
                    html += '</tr>';
                }
                html += '</table>';
                container.innerHTML = html;
            },

            runMonteCarlo: function() {
                const panel = document.getElementById('mc-panel');
                panel.classList.remove('hidden');
                
                // Get inputs directly for clean state
                const inputs = { 
                    ltmRev: this.getVal('ltmRev'), 
                    avgGrowth: this.getVal('avgGrowth') / 100, 
                    avgMargin: this.getVal('avgMargin') / 100, 
                    capexPct: this.getVal('capexPct') / 100, 
                    taxRate: this.getVal('taxRate') / 100 
                };
                
                const stats = StochasticEngine.runSimulation(inputs, this.currentWacc);
                
                // Update text stats
                document.getElementById('mc-p05').innerText = this.fmtShare(stats.p05);
                document.getElementById('mc-median').innerText = this.fmtShare(stats.median);
                document.getElementById('mc-p95').innerText = this.fmtShare(stats.p95);
                document.getElementById('mc-stats-mean').innerText = `Mean: ${this.fmtShare(stats.mean)}`;
                
                // Render Histogram
                this.renderMcChart(stats.dataset);
                
                // Scroll to view
                panel.scrollIntoView({ behavior: 'smooth' });
            },

            renderMcChart: function(data) {
                if(this.mcChartInstance) this.mcChartInstance.destroy();
                const ctx = document.getElementById('chart-mc').getContext('2d');

                // Bucketing Logic
                const bucketCount = 25;
                const min = data[0];
                const max = data[data.length-1];
                const range = max - min;
                const bucketSize = range / bucketCount;
                const buckets = new Array(bucketCount).fill(0);
                const labels = [];

                for(let i=0; i<bucketCount; i++) {
                    labels.push(Math.round(min + (i * bucketSize)));
                }

                data.forEach(val => {
                    const idx = Math.min(Math.floor((val - min) / bucketSize), bucketCount-1);
                    buckets[idx]++;
                });

                this.mcChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frequency',
                            data: buckets,
                            backgroundColor: buckets.map((v, i) => {
                                // Highlight the median bucket area
                                return (i > bucketCount/2 - 2 && i < bucketCount/2 + 2) ? '#a855f7' : 'rgba(168, 85, 247, 0.3)';
                            }),
                            borderRadius: 2
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { title: (c) => `Share Price ~$${c[0].label}` } } },
                        scales: {
                            x: { ticks: { color: '#64748b', maxTicksLimit: 8, font: {size: 9, family: 'monospace'} }, grid: { display: false } },
                            y: { display: false }
                        }
                    }
                });
            },

            exportCSV: function() {
                if(!this.lastProj.length) return;
                let csv = "Year,Revenue,EBITDA,UFCF\n";
                this.lastProj.forEach(p => {
                    csv += `${p.year},${p.rev.toFixed(2)},${p.ebitda.toFixed(2)},${p.ufcf.toFixed(2)}\n`;
                });
                
                const ev = document.getElementById('val-ev').innerText;
                const eq = document.getElementById('val-eq').innerText;
                const share = document.getElementById('val-share').innerText;
                const wacc = document.getElementById('val-wacc').innerText;

                csv += `\n--- VALUATION SUMMARY ---\nEnterprise Value,${ev}\nEquity Value,${eq}\nImplied Share Price,${share}\nWACC,${wacc}\n`;
                
                // Add Simulation data if it exists in DOM (simple check)
                const mcMedian = document.getElementById('mc-median').innerText;
                if(mcMedian !== '$0.00') {
                     csv += `\n--- MONTE CARLO SIMULATION ---\nMedian Price,${mcMedian}\nBear Case (P05),${document.getElementById('mc-p05').innerText}\nBull Case (P95),${document.getElementById('mc-p95').innerText}\n`;
                }

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.setAttribute('hidden', '');
                a.setAttribute('href', url);
                a.setAttribute('download', 'adam_dcf_model.csv');
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
        };

        // Init
        window.onload = function() {
            lucide.createIcons();
            app.runModel();
        };
    </script>
</body>
</html>
