<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM v23 | Repository Browser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .tree-line {
            position: absolute; left: 14px; top: 0; bottom: 0; width: 1px; background: #334155;
        }
        .tree-item {
            position: relative;
        }
        .tree-item::before {
            content: ''; position: absolute; left: -14px; top: 14px; width: 12px; height: 1px; background: #334155;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans h-screen flex flex-col grid-bg">
    <div class="scan-line"></div>

    <header class="h-16 border-b border-slate-700/50 flex items-center justify-between px-6 bg-[#0f172a]/90 backdrop-blur-md z-40 shrink-0">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold tracking-tight mono">ADAM <span class="text-teal-400">v23</span> <span class="text-slate-500 font-normal">| Repository Browser</span></h1>
        </div>
        <div class="flex gap-4 font-mono text-xs text-slate-400">
             <div id="file-stats">Indexing...</div>
        </div>
    </header>

    <main class="flex-1 p-6 overflow-hidden flex gap-6">
        <!-- Tree View -->
        <div class="w-1/3 glass-panel rounded-lg overflow-y-auto custom-scrollbar p-4" id="file-tree">
            <div class="text-center text-slate-500 mt-10">
                <i class="fas fa-circle-notch fa-spin mb-2"></i><br>
                Loading file structure...
            </div>
        </div>

        <!-- Preview/Info -->
        <div class="flex-1 glass-panel rounded-lg p-8 flex flex-col justify-center items-center text-slate-500 border border-slate-700/50">
            <i class="fas fa-folder-open text-6xl mb-4 opacity-20"></i>
            <p>Select a file to view details or open in Universal Viewer.</p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Fetch the index generated by Python script
                // We access it relative to showcase/
                const res = await fetch('data/repo_full_index.json');
                if(!res.ok) throw new Error("Index not found");
                const index = await res.json();

                renderTree(index);
                document.getElementById('file-stats').innerText = `${index.files.length} Files Indexed`;

            } catch (e) {
                console.error(e);
                document.getElementById('file-tree').innerHTML = '<div class="text-red-400 p-4">Failed to load repository index.<br>Run <code>scripts/generate_showcase_data.py</code> first.</div>';
            }
        });

        function renderTree(index) {
            const container = document.getElementById('file-tree');
            container.innerHTML = '';

            // Build hierarchy
            const root = {};

            index.files.forEach(file => {
                const parts = file.path.split('/');
                let current = root;
                parts.forEach((part, i) => {
                    if (i === parts.length - 1) {
                        // File
                        if(!current._files) current._files = [];
                        current._files.push(file);
                    } else {
                        // Directory
                        if(!current[part]) current[part] = {};
                        current = current[part];
                    }
                });
            });

            container.appendChild(createNode(root, 'root', true));
        }

        function createNode(node, name, isOpen = false) {
            const ul = document.createElement('ul');
            ul.className = 'pl-4 border-l border-slate-700/50 ml-1 space-y-1';
            if(!isOpen) ul.style.display = 'none';

            // Directories
            Object.keys(node).sort().forEach(key => {
                if(key === '_files') return;

                const li = document.createElement('li');
                const div = document.createElement('div');
                div.className = 'flex items-center cursor-pointer hover:text-white group py-0.5 text-sm text-slate-400 font-mono';
                div.innerHTML = `<i class="fas fa-folder text-slate-600 mr-2 group-hover:text-amber-400 transition"></i> ${key}`;

                const childUl = createNode(node[key], key);

                div.onclick = (e) => {
                    e.stopPropagation();
                    const isHidden = childUl.style.display === 'none';
                    childUl.style.display = isHidden ? 'block' : 'none';
                    div.querySelector('i').className = isHidden ? 'fas fa-folder-open text-amber-400 mr-2' : 'fas fa-folder text-slate-600 mr-2';
                };

                li.appendChild(div);
                li.appendChild(childUl);
                ul.appendChild(li);
            });

            // Files
            if(node._files) {
                node._files.sort((a,b) => a.name.localeCompare(b.name)).forEach(f => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center cursor-pointer hover:bg-slate-800/50 py-0.5 px-2 rounded text-xs text-slate-500 hover:text-cyan-400 transition font-mono';

                    let icon = 'fa-file';
                    if(f.extension === '.py') icon = 'fa-python';
                    if(f.extension === '.js') icon = 'fa-js';
                    if(f.extension === '.html') icon = 'fa-html5';
                    if(f.extension === '.md') icon = 'fa-book';
                    if(f.extension === '.json') icon = 'fa-database';

                    li.innerHTML = `<i class="fab ${icon} w-4 mr-1 opacity-70"></i> ${f.name}`;
                    li.onclick = (e) => {
                        e.stopPropagation();
                        openFile(f);
                    };
                    ul.appendChild(li);
                });
            }

            return ul;
        }

        function openFile(file) {
            // Send message to shell to open viewer
            if(window.parent) {
                window.parent.postMessage({
                    type: 'OPEN_VIEWER',
                    filename: file.name,
                    fileData: file // Contains path relative to repo root
                }, '*');
            }
        }
    </script>
</body>
</html>
