<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM v26.0 :: FORENSIC LAB</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/nav.js" defer></script>
    <style>
        :root {
            --bg-color: #050b14;
            --panel-bg: rgba(15, 23, 42, 0.6);
            --border-color: #334155;
            --text-primary: #e2e8f0;
            --accent-red: #ef4444;
            --accent-orange: #f97316;
            --accent-blue: #0ea5e9;
        }
        body { background-color: var(--bg-color); color: var(--text-primary); font-family: 'Inter', sans-serif; margin: 0; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        .header {
            border-bottom: 1px solid var(--border-color);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(5, 11, 20, 0.95);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 80px);
        }

        .sidebar {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .case-file {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .case-file:hover { background: rgba(255,255,255,0.05); }
        .case-file.active { border-left-color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
        .case-file.clean { border-left-color: var(--accent-blue); }

        .risk-badge {
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
            background: #333; color: #ccc; display: inline-block; margin-top: 5px;
        }
        .risk-high { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); border: 1px solid var(--accent-red); }
        .risk-low { background: rgba(14, 165, 233, 0.2); color: var(--accent-blue); border: 1px solid var(--accent-blue); }

        .main-panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 30px;
            position: relative;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border-color);
            padding: 15px;
            text-align: center;
        }
        .stat-val { font-size: 1.5rem; font-weight: bold; margin-top: 5px; }

        .anomaly-list {
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 30px;
        }
        .anomaly-item {
            display: flex; gap: 10px; align-items: start; margin-bottom: 10px;
            padding-bottom: 10px; border-bottom: 1px solid #333;
        }
        .anomaly-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

        .toggle-switch {
            display: flex; align-items: center; gap: 10px;
            background: #1e293b; padding: 5px 10px; border-radius: 20px; cursor: pointer;
            border: 1px solid var(--border-color);
        }
        .toggle-circle {
            width: 16px; height: 16px; border-radius: 50%; background: #64748b; transition: all 0.3s;
        }
        .toggle-active .toggle-circle { background: var(--accent-red); transform: translateX(100%); }

        .chart-wrapper {
            height: 400px;
            width: 100%;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
        }

        /* Glitch text effect for "RESTATEMENT" */
        .glitch-text {
            color: var(--accent-red);
            position: relative;
            display: inline-block;
        }

    </style>
</head>
<body>
    <header class="header">
        <div class="flex items-center gap-4">
            <i class="fas fa-search-dollar text-red-500 text-xl"></i>
            <div>
                <h1 class="text-xl font-bold tracking-tight mono">FORENSIC LAB <span class="text-red-500">// FRAUD DETECTION UNIT</span></h1>
                <div class="text-xs text-slate-400 mono">Agent: Forensic_Unit_01 | Status: ACTIVE</div>
            </div>
        </div>
        <div>
            <a href="market_mayhem_rebuild.html" class="text-sm text-slate-400 hover:text-white transition mono">
                <i class="fas fa-arrow-left mr-2"></i> RETURN TO HUB
            </a>
        </div>
    </header>

    <div class="dashboard-container">
        <!-- Sidebar: Case Files -->
        <aside class="sidebar">
            <h2 class="text-sm uppercase text-slate-500 font-bold tracking-wider mb-2">Active Investigations</h2>
            <div id="caseList">
                <!-- Injected via JS -->
                <div class="p-4 text-center text-slate-500">Loading Cases...</div>
            </div>
        </aside>

        <!-- Main Panel: Investigation Details -->
        <main class="main-panel">
            <div id="emptyState" class="flex flex-col items-center justify-center h-full text-slate-500">
                <i class="fas fa-folder-open text-4xl mb-4 opacity-50"></i>
                <p>Select a case file to begin analysis.</p>
            </div>

            <div id="caseContent" style="display: none;">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 id="companyName" class="text-3xl font-bold text-white mb-1">Company Name</h2>
                        <div id="companySector" class="text-sm text-cyan-400 mono mb-2">SECTOR</div>
                        <p id="companyDesc" class="text-slate-400 text-sm max-w-xl">Description...</p>
                    </div>

                    <div class="flex flex-col items-end gap-2">
                        <div id="riskBadge" class="px-3 py-1 rounded text-xs font-bold bg-slate-800 text-slate-400 border border-slate-700">
                            RISK SCORE: 0
                        </div>
                        <div class="toggle-switch" onclick="toggleRestatement()" id="restatementToggle">
                            <span class="text-xs text-slate-300 font-bold">RESTATE FINANCIALS</span>
                            <div style="width: 32px; height: 16px; background: #334155; border-radius: 10px; position: relative;">
                                <div id="toggleKnob" style="width: 12px; height: 12px; background: #94a3b8; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: all 0.2s;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="stat-grid mono">
                    <div class="stat-card">
                        <div class="text-xs text-slate-500 uppercase">Revenue Impact</div>
                        <div id="impactVal" class="stat-val text-slate-300">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-xs text-slate-500 uppercase">Anomalies Detected</div>
                        <div id="anomalyCount" class="stat-val text-slate-300">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-xs text-slate-500 uppercase">Restatement Date</div>
                        <div id="restatementDate" class="stat-val text-slate-300">--</div>
                    </div>
                </div>

                <div id="anomalySection" class="anomaly-list hidden">
                    <h3 class="text-red-400 text-sm font-bold uppercase mb-4"><i class="fas fa-exclamation-triangle mr-2"></i> Detected Anomalies</h3>
                    <div id="anomalyContainer"></div>
                </div>

                <div class="chart-wrapper">
                    <canvas id="financialChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script>
        let casesData = [];
        let currentCase = null;
        let isRestated = false;
        let chartInstance = null;

        async function loadCases() {
            try {
                const response = await fetch('data/fraud_cases.json');
                casesData = await response.json();
                renderSidebar();

                // Auto-select first case with anomalies if any, else first case
                const suspicious = casesData.find(c => c.anomalies.length > 0);
                if (suspicious) selectCase(casesData.indexOf(suspicious));
                else if (casesData.length > 0) selectCase(0);

            } catch (e) {
                console.error("Failed to load cases", e);
                document.getElementById('caseList').innerHTML = '<div class="text-red-500 p-4">Error loading data.</div>';
            }
        }

        function renderSidebar() {
            const container = document.getElementById('caseList');
            container.innerHTML = '';

            casesData.forEach((c, index) => {
                const isHighRisk = c.impact_assessment.risk_score > 20;
                const badgeClass = isHighRisk ? 'risk-high' : 'risk-low';
                const badgeText = isHighRisk ? 'HIGH RISK' : 'LOW RISK';

                const div = document.createElement('div');
                div.className = `case-file ${isHighRisk ? '' : 'clean'}`;
                div.id = `case-${index}`;
                div.onclick = () => selectCase(index);
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-slate-200 text-sm">${c.company}</div>
                        <div class="mono text-xs text-slate-500">${c.sector}</div>
                    </div>
                    <div class="risk-badge ${badgeClass} mono">${badgeText}</div>
                `;
                container.appendChild(div);
            });
        }

        function selectCase(index) {
            currentCase = casesData[index];
            isRestated = false; // Reset toggle
            updateToggleUI();

            // Highlight Sidebar
            document.querySelectorAll('.case-file').forEach(el => el.classList.remove('active'));
            document.getElementById(`case-${index}`).classList.add('active');

            // Show Content
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('caseContent').style.display = 'block';

            // Populate Info
            document.getElementById('companyName').innerText = currentCase.company;
            document.getElementById('companySector').innerText = currentCase.sector.toUpperCase();
            document.getElementById('companyDesc').innerText = currentCase.description;

            // Risk Badge
            const riskScore = currentCase.impact_assessment.risk_score;
            const riskEl = document.getElementById('riskBadge');
            riskEl.innerText = `RISK SCORE: ${riskScore} / 100`;
            riskEl.className = riskScore > 20
                ? 'px-3 py-1 rounded text-xs font-bold bg-red-900/30 text-red-400 border border-red-500 mono'
                : 'px-3 py-1 rounded text-xs font-bold bg-blue-900/30 text-blue-400 border border-blue-500 mono';

            // Stats
            const impact = currentCase.impact_assessment.revenue_impact_pct;
            const impactEl = document.getElementById('impactVal');
            impactEl.innerText = `${impact}%`;
            impactEl.style.color = impact < 0 ? '#ef4444' : '#10b981';

            document.getElementById('anomalyCount').innerText = currentCase.anomalies.length;
            document.getElementById('restatementDate').innerText = currentCase.restated_financials.restatement_date || "N/A";

            // Anomalies
            const anomalyContainer = document.getElementById('anomalyContainer');
            const anomalySection = document.getElementById('anomalySection');

            if (currentCase.anomalies.length > 0) {
                anomalySection.classList.remove('hidden');
                anomalyContainer.innerHTML = currentCase.anomalies.map(a => `
                    <div class="anomaly-item">
                        <i class="fas fa-bug text-red-500 mt-1"></i>
                        <div class="text-sm text-slate-300">${a}</div>
                    </div>
                `).join('');
            } else {
                anomalySection.classList.add('hidden');
            }

            renderChart();
        }

        function toggleRestatement() {
            isRestated = !isRestated;
            updateToggleUI();
            renderChart();
        }

        function updateToggleUI() {
            const knob = document.getElementById('toggleKnob');
            if (isRestated) {
                knob.style.left = '18px';
                knob.style.background = '#ef4444';
            } else {
                knob.style.left = '2px';
                knob.style.background = '#94a3b8';
            }
        }

        function renderChart() {
            const ctx = document.getElementById('financialChart').getContext('2d');

            if (chartInstance) chartInstance.destroy();

            const original = currentCase.original_financials;
            const restated = currentCase.restated_financials;

            // Metrics to display
            const labels = ['Revenue', 'Expenses', 'Net Income', 'Cash Flow'];

            const dataOriginal = [
                original.revenue,
                original.expenses,
                original.net_income,
                original.cash_flow
            ];

            const dataRestated = [
                restated.revenue,
                restated.expenses,
                restated.net_income,
                restated.cash_flow
            ];

            // If clean, restated equals original, so maybe just show one bar?
            // But we want to simulate the "Switch".
            // If isRestated is true, we show Red bars (Restated).
            // If false, we show Blue bars (Reported).

            const activeData = isRestated ? dataRestated : dataOriginal;
            const activeColor = isRestated ? 'rgba(239, 68, 68, 0.6)' : 'rgba(14, 165, 233, 0.6)';
            const activeBorder = isRestated ? '#ef4444' : '#0ea5e9';
            const label = isRestated ? 'Restated Financials (Audit)' : 'Reported Financials (10-K)';

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: activeData,
                        backgroundColor: activeColor,
                        borderColor: activeBorder,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#cbd5e1', font: { family: 'JetBrains Mono' } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumSignificantDigits: 3 }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8', callback: function(value) { return '$' + value / 1000000 + 'M'; } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8', font: { family: 'JetBrains Mono' } }
                        }
                    },
                    animation: {
                        duration: 500
                    }
                }
            });
        }

        loadCases();
    </script>
</body>
</html>
