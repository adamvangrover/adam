<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM :: PORTFOLIO ANALYTICS</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0b1120; color: #cbd5e1; font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .glass-panel {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(51, 65, 85, 0.5);
            backdrop-filter: blur(12px);
        }
        select { background-image: none; } /* Reset default arrow */
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="h-16 border-b border-slate-700 flex items-center justify-between px-6 bg-slate-900 z-10">
        <div class="flex items-center gap-4">
            <a href="house_view_library.html" class="text-slate-400 hover:text-white"><i class="fas fa-arrow-left"></i> Strategy</a>
            <h1 class="text-xl font-bold text-white tracking-tight">PORTFOLIO <span class="text-cyan-400">COMMAND</span></h1>
        </div>

        <div class="flex items-center gap-4">
            <!-- Time Controls -->
            <div class="flex items-center gap-3 bg-slate-800 rounded-lg px-3 py-1 border border-slate-700">
                <button id="play-btn" class="text-cyan-400 hover:text-white transition"><i class="fas fa-play"></i></button>
                <div class="text-xs font-mono w-24 text-center text-white" id="display-date">LOADING...</div>
                <input type="range" id="time-slider" min="0" max="100" value="100" class="w-32 h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-cyan-500">
            </div>

            <div class="h-4 w-px bg-slate-700"></div>

            <div class="hidden md:block text-xs font-mono text-cyan-200 uppercase" id="market-narrative">SYSTEM INITIALIZING...</div>

            <div class="h-4 w-px bg-slate-700"></div>

            <select id="portfolio-select" class="bg-slate-800 border border-slate-600 text-white text-sm rounded px-3 py-1 focus:outline-none focus:border-cyan-500">
                <option value="aggressive">Aggressive Growth (AI/Crypto)</option>
                <option value="balanced">Balanced (60/40 Optimized)</option>
                <option value="defensive">Defensive (Yield/Gold)</option>
            </select>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">

        <!-- Left Sidebar: Stats -->
        <aside class="w-80 border-r border-slate-700 p-6 flex flex-col gap-6 bg-slate-900/50 overflow-y-auto">

            <div class="glass-panel p-4 rounded-lg">
                <h3 class="text-xs text-slate-400 uppercase tracking-widest mb-1">Total Return (YTD)</h3>
                <div class="text-3xl font-bold text-emerald-400 mono" id="stat-return">+0.0%</div>
            </div>

            <div class="glass-panel p-4 rounded-lg">
                <h3 class="text-xs text-slate-400 uppercase tracking-widest mb-1">Sharpe Ratio</h3>
                <div class="text-xl font-bold text-white mono" id="stat-sharpe">0.00</div>
            </div>

            <div class="glass-panel p-4 rounded-lg">
                <h3 class="text-xs text-slate-400 uppercase tracking-widest mb-1">Max Drawdown</h3>
                <div class="text-xl font-bold text-red-400 mono" id="stat-drawdown">-0.0%</div>
            </div>

            <div class="mt-auto">
                <h3 class="text-xs text-slate-500 mb-2">Current Allocation</h3>
                <canvas id="allocationChart" height="200"></canvas>
            </div>

        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col p-6 gap-6 overflow-y-auto">

            <!-- Chart Section -->
            <div class="glass-panel rounded-xl p-6 relative min-h-[400px]">
                <h2 class="text-lg font-bold text-white mb-4">Performance Simulation</h2>
                <div class="absolute top-6 right-6 flex gap-2">
                    <button class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded text-white transition">1M</button>
                    <button class="px-3 py-1 text-xs bg-cyan-600 text-white rounded transition">YTD</button>
                    <button class="px-3 py-1 text-xs bg-slate-700 hover:bg-slate-600 rounded text-white transition">1Y</button>
                </div>
                <div class="w-full h-[350px]">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>

            <!-- Holdings Table -->
            <div class="glass-panel rounded-xl p-0 overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-white">Top Holdings</h2>
                    <span class="text-xs text-slate-500 italic">Live Pricing Simulation</span>
                </div>
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-800/50">
                        <tr>
                            <th class="px-6 py-3">Ticker</th>
                            <th class="px-6 py-3">Name</th>
                            <th class="px-6 py-3">Sector</th>
                            <th class="px-6 py-3 text-right">Weight</th>
                            <th class="px-6 py-3 text-right">P/L</th>
                        </tr>
                    </thead>
                    <tbody id="holdings-body" class="divide-y divide-slate-700/50">
                        <!-- Injected JS -->
                    </tbody>
                </table>
            </div>

        </div>

    </main>

    <script>
        // --- Data State ---
        let HISTORY_DATA = [];
        let CURRENT_INDEX = 0;
        let ACTIVE_PORTFOLIO = 'aggressive';

        // --- Static Configs ---
        const PORTFOLIO_CONFIG = {
            aggressive: {
                allocationLabels: ['AI Tech', 'Crypto', 'Growth', 'Cash'],
                allocation: [40, 30, 20, 10],
                holdings: [
                    { ticker: 'NVDA', name: 'Nvidia Corp', sector: 'Semiconductors', weight: '15.0%' },
                    { ticker: 'BTC', name: 'Bitcoin', sector: 'Crypto', weight: '12.0%' },
                    { ticker: 'PLTR', name: 'Palantir', sector: 'Software', weight: '8.0%' },
                    { ticker: 'MSTR', name: 'MicroStrategy', sector: 'Software', weight: '5.0%' }
                ]
            },
            balanced: {
                allocationLabels: ['Global Equity', 'Bonds', 'Real Assets', 'Cash'],
                allocation: [50, 30, 10, 10],
                holdings: [
                    { ticker: 'VTI', name: 'Total Stock Mkt', sector: 'Equity ETF', weight: '30.0%' },
                    { ticker: 'BND', name: 'Total Bond Mkt', sector: 'Fixed Income', weight: '25.0%' },
                    { ticker: 'GLD', name: 'Gold Trust', sector: 'Commodity', weight: '10.0%' },
                    { ticker: 'MSFT', name: 'Microsoft', sector: 'Tech', weight: '5.0%' }
                ]
            },
            defensive: {
                allocationLabels: ['Equity', 'Govt Bonds', 'Gold', 'Cash'],
                allocation: [20, 60, 10, 10],
                holdings: [
                    { ticker: 'SHV', name: 'Short Treasury', sector: 'Fixed Income', weight: '40.0%' },
                    { ticker: 'XLU', name: 'Utilities Select', sector: 'Utilities', weight: '15.0%' },
                    { ticker: 'JNJ', name: 'Johnson & Johnson', sector: 'Healthcare', weight: '10.0%' },
                    { ticker: 'GLD', name: 'Gold', sector: 'Commodity', weight: '10.0%' }
                ]
            }
        };

        // --- Charts ---
        let perfChart = null;
        let allocChart = null;

        function initCharts() {
            // Performance Chart
            const ctxP = document.getElementById('performanceChart').getContext('2d');
            perfChart = new Chart(ctxP, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Portfolio Value',
                        data: [],
                        borderColor: '#06b6d4',
                        backgroundColor: 'rgba(6, 182, 212, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    animation: { duration: 0 } // Disable animation for slider performance
                }
            });

            // Allocation Chart
            const ctxA = document.getElementById('allocationChart').getContext('2d');
            allocChart = new Chart(ctxA, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: ['#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'bottom', labels: { color: '#94a3b8', font: { size: 10 } } } }
                }
            });
        }

        async function loadData() {
            try {
                const response = await fetch('data/portfolio_history.json');
                HISTORY_DATA = await response.json();

                // Initialize with full data
                CURRENT_INDEX = HISTORY_DATA.length - 1;

                // Update Slider Range
                const slider = document.getElementById('time-slider');
                slider.max = HISTORY_DATA.length - 1;
                slider.value = CURRENT_INDEX;

                updateDashboard();

                // Expose for external control (slider)
                window.HISTORY_DATA = HISTORY_DATA;
                window.updateDashboard = updateDashboard;

            } catch (e) {
                console.error("Failed to load portfolio history:", e);
                // Fallback or alert?
            }
        }

        function calculateStats(historySlice, pKey) {
            if (historySlice.length === 0) return { ret: "0%", sharpe: "0.00", dd: "0%" };

            const startVal = historySlice[0].portfolios[pKey].value;
            const endVal = historySlice[historySlice.length - 1].portfolios[pKey].value;
            const ret = ((endVal - startVal) / startVal) * 100;

            // Drawdown
            let maxVal = -Infinity;
            let maxDD = 0;
            for (const day of historySlice) {
                const val = day.portfolios[pKey].value;
                if (val > maxVal) maxVal = val;
                const dd = (val - maxVal) / maxVal;
                if (dd < maxDD) maxDD = dd;
            }

            // Fake Sharpe (based on return sign/magnitude for simulation)
            const sharpe = ret > 0 ? (1 + Math.random()).toFixed(2) : (Math.random() - 0.5).toFixed(2);

            return {
                ret: (ret > 0 ? "+" : "") + ret.toFixed(1) + "%",
                sharpe: sharpe,
                dd: (maxDD * 100).toFixed(1) + "%"
            };
        }

        function updateDashboard(indexOverride) {
            if (indexOverride !== undefined) CURRENT_INDEX = indexOverride;
            if (HISTORY_DATA.length === 0) return;

            const idx = Math.min(CURRENT_INDEX, HISTORY_DATA.length - 1);
            const currentDay = HISTORY_DATA[idx];
            const pKey = ACTIVE_PORTFOLIO;

            // Slice history for chart (last 90 days or from start)
            const lookback = 90;
            const startIdx = Math.max(0, idx - lookback);
            const historySlice = HISTORY_DATA.slice(startIdx, idx + 1);

            // Update Stats
            // We calculate YTD return relative to start of history (or Jan 1st if we had logic)
            // For simplicity: relative to start of generated history
            const fullHistorySlice = HISTORY_DATA.slice(0, idx + 1);
            const stats = calculateStats(fullHistorySlice, pKey);

            document.getElementById('stat-return').innerText = stats.ret;
            document.getElementById('stat-return').className = `text-3xl font-bold mono ${stats.ret.includes('-') ? 'text-red-400' : 'text-emerald-400'}`;

            document.getElementById('stat-sharpe').innerText = stats.sharpe;
            document.getElementById('stat-drawdown').innerText = stats.dd;

            // Update Perf Chart
            perfChart.data.labels = historySlice.map(d => d.date);
            perfChart.data.datasets[0].data = historySlice.map(d => d.portfolios[pKey].value);
            perfChart.update();

            // Update Allocation Chart
            const config = PORTFOLIO_CONFIG[pKey];
            allocChart.data.labels = config.allocationLabels;
            allocChart.data.datasets[0].data = config.allocation;
            allocChart.update();

            // Update Holdings (Simulate P/L based on daily return noise)
            const tbody = document.getElementById('holdings-body');
            tbody.innerHTML = '';

            // Simulate P/L based on total return roughly
            const totalRetVal = parseFloat(stats.ret.replace('%', ''));

            config.holdings.forEach(h => {
                // Add some variance to holding P/L based on ticker name hash or similar for consistency?
                // Just randomize slightly around total return
                const variance = (Math.random() - 0.5) * 20;
                let itemPL = totalRetVal + variance;
                if (h.ticker === 'BTC') itemPL *= 1.5; // Crypto moves more

                const plStr = (itemPL > 0 ? "+" : "") + itemPL.toFixed(1) + "%";
                const plColor = itemPL > 0 ? 'text-emerald-400' : 'text-red-400';

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-800/50 transition">
                        <td class="px-6 py-3 font-mono text-white">${h.ticker}</td>
                        <td class="px-6 py-3 text-slate-300">${h.name}</td>
                        <td class="px-6 py-3 text-slate-400">${h.sector}</td>
                        <td class="px-6 py-3 text-right font-mono">${h.weight}</td>
                        <td class="px-6 py-3 text-right font-mono ${plColor}">${plStr}</td>
                    </tr>
                `;
            });

            // Update Narrative/Date Display if element exists (will add in next step)
            if (document.getElementById('display-date')) {
                document.getElementById('display-date').innerText = currentDay.date;
            }
            if (document.getElementById('market-narrative')) {
                document.getElementById('market-narrative').innerText = currentDay.portfolios[pKey].narrative.toUpperCase();
            }
        }

        // --- Playback Logic ---
        let PLAY_INTERVAL = null;

        function togglePlay() {
            const btn = document.getElementById('play-btn');
            const icon = btn.querySelector('i');

            if (PLAY_INTERVAL) {
                clearInterval(PLAY_INTERVAL);
                PLAY_INTERVAL = null;
                icon.className = 'fas fa-play';
            } else {
                icon.className = 'fas fa-pause text-emerald-400';
                PLAY_INTERVAL = setInterval(() => {
                    let nextIdx = CURRENT_INDEX + 1;
                    if (nextIdx >= HISTORY_DATA.length) nextIdx = 0;

                    document.getElementById('time-slider').value = nextIdx;
                    updateDashboard(nextIdx);
                }, 100); // 100ms per day
            }
        }

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadData();

            document.getElementById('portfolio-select').addEventListener('change', (e) => {
                ACTIVE_PORTFOLIO = e.target.value;
                updateDashboard();
            });

            const slider = document.getElementById('time-slider');
            slider.addEventListener('input', (e) => {
                if (PLAY_INTERVAL) togglePlay(); // Stop if user interacts
                updateDashboard(parseInt(e.target.value));
            });

            document.getElementById('play-btn').addEventListener('click', togglePlay);
        });

    </script>
</body>
</html>
