<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM v23.5 | Financial Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* --- CORE THEME: ADAM TERMINAL --- */
        :root {
            --bg-dark: #050b14;
            --panel-glass: rgba(15, 23, 42, 0.6);
            --cyan-glow: #06b6d4;
            --purple-glow: #8b5cf6;
            --green-glow: #10b981;
            --red-glow: #ef4444;
        }

        body { 
            background-color: var(--bg-dark); 
            color: #e2e8f0; 
            font-family: 'Courier New', Courier, monospace; 
            overflow-x: hidden;
        }

        /* Glassmorphism Panel */
        .glass-panel { 
            background: var(--panel-glass); 
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* CRT Scanline Effect */
        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 50;
            opacity: 0.3;
        }

        /* Custom Inputs */
        input[type="number"], select { 
            background: #0f172a; 
            border: 1px solid #334155; 
            color: #fff; 
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }
        input[type="number"]:focus, select:focus { 
            border-color: var(--cyan-glow); 
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.2); 
            outline: none; 
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            width: 100%; 
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%;
            background: var(--cyan-glow);
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px var(--cyan-glow);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }

        /* KPI Cards */
        .cyber-card { 
            border-left: 4px solid var(--cyan-glow); 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .cyber-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.15); 
        }
        .cyber-card.alert { border-left-color: var(--red-glow); }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .tab-btn.active {
            color: var(--cyan-glow);
            border-bottom: 2px solid var(--cyan-glow);
            text-shadow: 0 0 8px rgba(6, 182, 212, 0.4);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-6">
    
    <div class="scanlines"></div>

    <header class="max-w-[1600px] mx-auto w-full mb-6 flex flex-col md:flex-row justify-between items-center border-b border-gray-800 pb-4 relative z-10">
        <div class="flex items-center space-x-4 mb-4 md:mb-0">
            <div class="h-10 w-10 bg-cyan-900/20 border border-cyan-500 rounded flex items-center justify-center text-cyan-400 font-bold text-xl">A</div>
            <div>
                <h1 class="text-2xl font-bold text-white tracking-widest uppercase">ADAM <span class="text-cyan-400">ENGINE</span></h1>
                <p class="text-[10px] text-gray-500 tracking-[0.2em] uppercase">Financial Intelligence Unit v24.0</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="saveScenario()" class="px-3 py-1 text-xs border border-gray-700 rounded hover:border-cyan-500 hover:text-cyan-400 transition">SAVE STATE</button>
            <button onclick="loadScenario()" class="px-3 py-1 text-xs border border-gray-700 rounded hover:border-cyan-500 hover:text-cyan-400 transition">LOAD LAST</button>
            <button onclick="exportReport()" class="px-3 py-1 text-xs bg-cyan-900/30 border border-cyan-500/50 rounded text-cyan-400 hover:bg-cyan-500 hover:text-white transition">EXPORT PDF</button>
            <div class="ml-4 pl-4 border-l border-gray-800 text-right hidden md:block">
                <div class="text-[10px] text-green-500 font-mono animate-pulse">● SYSTEM ONLINE</div>
                <div class="text-[10px] text-gray-600">LATENCY: 12ms</div>
            </div>
        </div>
    </header>

    <div class="max-w-[1600px] mx-auto w-full grid grid-cols-12 gap-6 relative z-10 flex-grow">
        
        <aside class="col-span-12 lg:col-span-3 space-y-6">
            
            <div class="glass-panel p-5 rounded-lg border-t-2 border-t-cyan-500/50">
                <h3 class="text-xs font-bold text-cyan-400 mb-4 uppercase tracking-wider flex justify-between">
                    1. Financial Inputs <span class="text-gray-600">LTM</span>
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="flex justify-between text-[10px] text-gray-400 mb-1">
                            <span>LTM EBITDA</span>
                            <span class="text-cyan-600" id="disp-ebitda">-</span>
                        </label>
                        <input type="number" id="ebitda" value="50000000" class="w-full px-2 py-1 rounded bg-slate-900 focus:ring-1 focus:ring-cyan-500" onchange="calculate()">
                    </div>
                    <div>
                        <label class="flex justify-between text-[10px] text-gray-400 mb-1">
                            <span>CAGR Growth</span>
                            <span class="text-cyan-600" id="disp-growth">5%</span>
                        </label>
                        <input type="range" id="growth" min="-5" max="30" step="0.5" value="5" oninput="calculate()">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1">Total Debt ($)</label>
                        <input type="number" id="debt" value="200000000" class="w-full px-2 py-1 rounded bg-slate-900" onchange="calculate()">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-400 mb-1">Annual Interest ($)</label>
                        <input type="number" id="interest" value="18000000" class="w-full px-2 py-1 rounded bg-slate-900" onchange="calculate()">
                    </div>
                </div>
            </div>

            <div class="glass-panel p-5 rounded-lg border-t-2 border-t-purple-500/50">
                <h3 class="text-xs font-bold text-purple-400 mb-4 uppercase tracking-wider">2. Capital Structure</h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] text-gray-400 mb-1">Entry Mult (x)</label>
                            <input type="number" id="entryMult" value="10.0" step="0.1" class="w-full px-2 py-1 rounded bg-slate-900" onchange="calculate()">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-400 mb-1">Cost Debt (%)</label>
                            <input type="number" id="costDebt" value="8.5" step="0.1" class="w-full px-2 py-1 rounded bg-slate-900" onchange="calculate()">
                        </div>
                    </div>
                    <div>
                        <label class="flex justify-between text-[10px] text-gray-400 mb-1">
                            <span>Equity Contribution</span>
                            <span class="text-purple-600" id="disp-equity">40%</span>
                        </label>
                        <input type="range" id="equityPct" min="10" max="100" value="40" oninput="calculate()">
                    </div>
                </div>
            </div>

            <div class="glass-panel p-5 rounded-lg border-t-2 border-t-green-500/50">
                <h3 class="text-xs font-bold text-green-400 mb-4 uppercase tracking-wider">3. Risk Simulation</h3>
                <div class="space-y-3">
                    <div>
                        <label class="flex justify-between text-[10px] text-gray-400 mb-1">
                            <span>Volatility (σ)</span>
                            <span class="text-green-600" id="disp-vol">15%</span>
                        </label>
                        <input type="range" id="volatility" min="5" max="60" value="15" oninput="document.getElementById('disp-vol').innerText = this.value + '%'">
                    </div>
                    <button onclick="runMonteCarlo()" class="w-full py-2 bg-green-900/20 border border-green-500/30 text-green-400 text-xs font-bold rounded hover:bg-green-500/20 transition">RUN MONTE CARLO</button>
                </div>
            </div>
        </aside>

        <main class="col-span-12 lg:col-span-9 flex flex-col space-y-6">
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass-panel p-4 rounded-lg cyber-card">
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest">Enterprise Value</div>
                    <div class="text-2xl md:text-3xl font-bold text-white mt-1 font-mono" id="kpi-ev">-</div>
                    <div class="text-[10px] text-cyan-600 mt-1">DCF Implied</div>
                </div>
                <div class="glass-panel p-4 rounded-lg cyber-card">
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest">WACC</div>
                    <div class="text-2xl md:text-3xl font-bold text-white mt-1 font-mono" id="kpi-wacc">-</div>
                    <div class="text-[10px] text-gray-600 mt-1">Discount Rate</div>
                </div>
                <div class="glass-panel p-4 rounded-lg cyber-card" id="card-rating">
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest">Reg Rating</div>
                    <div class="text-2xl md:text-3xl font-bold text-white mt-1 font-mono" id="kpi-rating">-</div>
                    <div class="text-[10px] text-gray-600 mt-1">Base Case</div>
                </div>
                <div class="glass-panel p-4 rounded-lg cyber-card" id="card-snc">
                    <div class="text-[10px] text-gray-500 uppercase tracking-widest">SNC Status</div>
                    <div class="text-2xl md:text-3xl font-bold text-white mt-1 font-mono" id="kpi-snc">-</div>
                    <div class="text-[10px] text-gray-600 mt-1">Shared National Credit</div>
                </div>
            </div>

            <div class="glass-panel rounded-lg flex-grow flex flex-col overflow-hidden min-h-[500px]">
                
                <div class="flex border-b border-gray-800 bg-gray-900/50">
                    <button onclick="switchTab('dcf')" id="btn-dcf" class="tab-btn active flex-1 py-3 text-xs font-bold uppercase tracking-wider text-gray-400 hover:bg-white/5 transition">DCF Model</button>
                    <button onclick="switchTab('credit')" id="btn-credit" class="tab-btn flex-1 py-3 text-xs font-bold uppercase tracking-wider text-gray-400 hover:bg-white/5 transition">Credit Risk</button>
                    <button onclick="switchTab('sponsor')" id="btn-sponsor" class="tab-btn flex-1 py-3 text-xs font-bold uppercase tracking-wider text-gray-400 hover:bg-white/5 transition">Sponsor/LBO</button>
                    <button onclick="switchTab('sensitivity')" id="btn-sensitivity" class="tab-btn flex-1 py-3 text-xs font-bold uppercase tracking-wider text-gray-400 hover:bg-white/5 transition">Heatmap</button>
                    <button onclick="switchTab('mc')" id="btn-mc" class="tab-btn flex-1 py-3 text-xs font-bold uppercase tracking-wider text-gray-400 hover:bg-white/5 transition">Monte Carlo</button>
                </div>

                <div id="tab-dcf" class="tab-content p-6 animate-fade-in flex flex-col h-full">
                    <div class="h-64 mb-6 relative w-full">
                        <canvas id="dcfChart"></canvas>
                    </div>
                    <div class="overflow-x-auto rounded border border-gray-800">
                        <table class="w-full text-left text-sm text-gray-300">
                            <thead class="bg-gray-900/80 text-[10px] uppercase text-gray-500">
                                <tr>
                                    <th class="py-2 px-4">Period</th>
                                    <th class="py-2 px-4">EBITDA</th>
                                    <th class="py-2 px-4">Free Cash Flow</th>
                                    <th class="py-2 px-4">Disc Factor</th>
                                    <th class="py-2 px-4">PV of FCF</th>
                                </tr>
                            </thead>
                            <tbody id="dcfTableBody" class="divide-y divide-gray-800 font-mono text-xs"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-credit" class="tab-content hidden p-6 animate-fade-in">
                    <h4 class="text-sm font-bold text-white mb-4">Downside Stress Test</h4>
                    <div class="overflow-x-auto rounded border border-gray-800 mb-6">
                        <table class="w-full text-left text-sm text-gray-300">
                            <thead class="bg-gray-900/80 text-[10px] uppercase text-gray-500">
                                <tr>
                                    <th class="py-2 px-4">Stress Scenario</th>
                                    <th class="py-2 px-4">Implied EBITDA</th>
                                    <th class="py-2 px-4">Leverage (x)</th>
                                    <th class="py-2 px-4">FCCR (x)</th>
                                    <th class="py-2 px-4">Rating</th>
                                </tr>
                            </thead>
                            <tbody id="creditTableBody" class="divide-y divide-gray-800 font-mono text-xs"></tbody>
                        </table>
                    </div>
                    <div class="p-4 bg-red-900/10 border border-red-900/30 rounded text-xs text-gray-400">
                        <strong>Note:</strong> Ratings are derived from internal logic mapping Leverage and Fixed Charge Coverage Ratio (FCCR) to regulatory pass grades. SNC status triggers if Debt > $100M.
                    </div>
                </div>

                <div id="tab-sponsor" class="tab-content hidden p-6 animate-fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 h-full">
                        <div>
                            <h4 class="text-sm font-bold text-white mb-4 border-b border-gray-800 pb-2">Exit Assumptions (Year 5)</h4>
                            <div class="mb-6">
                                <label class="flex justify-between text-xs text-gray-400 mb-2">
                                    <span>Exit Multiple</span>
                                    <span class="text-purple-400 font-mono" id="disp-exitMult">10.0x</span>
                                </label>
                                <input type="range" id="exitMult" min="4" max="20" step="0.5" value="10.0" oninput="calculate()">
                            </div>
                            
                            <div class="glass-panel p-4 rounded bg-gray-800/30 space-y-3 font-mono text-xs">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Projected Exit EBITDA</span>
                                    <span class="text-white" id="sponsor-ebitda">$0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">Net Debt at Exit (w/ Sweep)</span>
                                    <span class="text-red-400" id="sponsor-netdebt">$0</span>
                                </div>
                                <div class="border-t border-gray-700 pt-2 flex justify-between">
                                    <span class="text-purple-400 font-bold">Exit Equity Value</span>
                                    <span class="text-purple-400 font-bold" id="sponsor-exitequity">$0</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-col justify-center space-y-4">
                            <div class="glass-panel p-6 rounded text-center border border-gray-700 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                                <div class="text-[10px] text-gray-400 uppercase tracking-widest">MOIC (Multiple of Money)</div>
                                <div class="text-5xl font-bold text-white mt-2 mb-1 tracking-tighter" id="sponsor-moic">-</div>
                            </div>
                            <div class="glass-panel p-6 rounded text-center border border-gray-700 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
                                <div class="text-[10px] text-gray-400 uppercase tracking-widest">Internal Rate of Return (IRR)</div>
                                <div class="text-5xl font-bold text-cyan-400 mt-2 mb-1 tracking-tighter" id="sponsor-irr">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-sensitivity" class="tab-content hidden p-6 animate-fade-in flex flex-col items-center justify-center">
                    <h4 class="text-sm font-bold text-white mb-2">IRR Heatmap: Growth vs. Exit Multiple</h4>
                    <p class="text-[10px] text-gray-500 mb-6">Values represent Sponsor IRR (%)</p>
                    <div class="overflow-x-auto w-full flex justify-center">
                        <table class="text-center text-xs border-collapse" id="sens-table">
                            </table>
                    </div>
                </div>

                <div id="tab-mc" class="tab-content hidden p-6 animate-fade-in relative h-full flex flex-col">
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="glass-panel p-3 text-center">
                            <div class="text-[10px] text-gray-500 uppercase">Mean EV</div>
                            <div class="text-lg font-bold text-green-400 font-mono" id="mc-mean">-</div>
                        </div>
                        <div class="glass-panel p-3 text-center">
                            <div class="text-[10px] text-gray-500 uppercase">VaR (95%)</div>
                            <div class="text-lg font-bold text-red-400 font-mono" id="mc-var">-</div>
                        </div>
                        <div class="glass-panel p-3 text-center">
                            <div class="text-[10px] text-gray-500 uppercase">Solvency Prob</div>
                            <div class="text-lg font-bold text-cyan-400 font-mono" id="mc-prob">-</div>
                        </div>
                    </div>
                    <div class="flex-grow relative w-full">
                        <canvas id="mcChart"></canvas>
                        <div id="mc-loading" class="absolute inset-0 flex items-center justify-center bg-gray-900/90 backdrop-blur hidden z-20">
                            <div class="text-center">
                                <div class="text-green-500 font-mono text-xl animate-pulse">COMPUTING SCENARIOS...</div>
                                <div class="text-xs text-gray-500 mt-2">Geometric Brownian Motion (N=5000)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const CONFIG = {
            TAX_RATE: 0.21,
            RISK_FREE: 0.0425,
            MRP: 0.06,
            TERMINAL_GROWTH: 0.02,
            BETA: 1.2,
            YEARS: 5
        };

        const RATING_MAP = {
            1.0: "IG1 (AAA)", 3.0: "IG3 (BBB-)", 
            4.0: "Pass 4 (BB)", 5.0: "Pass 5 (B+)", 
            6.0: "Pass 6 (B-)", 7.0: "Special Mention", 8.0: "Substandard"
        };

        // --- STATE & CHARTS ---
        let charts = { dcf: null, mc: null };
        let state = { projections: [] };

        // --- UTILS ---
        const fmtMoney = (n) => {
            if (n >= 1e9) return "$" + (n/1e9).toFixed(1) + "B";
            if (n >= 1e6) return "$" + (n/1e6).toFixed(1) + "M";
            return "$" + n.toLocaleString(undefined, {maximumFractionDigits:0});
        };
        const fmtPct = (n) => (n*100).toFixed(1) + "%";

        // --- DOM CONTROLLER ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active', 'text-cyan-400', 'border-b-2', 'border-cyan-400'));
            const btn = document.getElementById(`btn-${id}`);
            if(btn) btn.classList.add('active');
            
            if(id === 'sensitivity') renderSensitivityTable();
        }

        // --- MAIN CALCULATION ENGINE ---
        function calculate() {
            // 1. Gather Inputs
            const inputs = {
                ebitda: parseFloat(document.getElementById('ebitda').value),
                growth: parseFloat(document.getElementById('growth').value) / 100,
                debt: parseFloat(document.getElementById('debt').value),
                interest: parseFloat(document.getElementById('interest').value),
                entryMult: parseFloat(document.getElementById('entryMult').value),
                costDebt: parseFloat(document.getElementById('costDebt').value) / 100,
                equityPct: parseFloat(document.getElementById('equityPct').value) / 100,
                exitMult: parseFloat(document.getElementById('exitMult').value)
            };

            // Update Input Displays
            document.getElementById('disp-ebitda').innerText = fmtMoney(inputs.ebitda);
            document.getElementById('disp-growth').innerText = (inputs.growth*100).toFixed(1) + "%";
            document.getElementById('disp-equity').innerText = (inputs.equityPct*100).toFixed(0) + "%";
            document.getElementById('disp-exitMult').innerText = inputs.exitMult.toFixed(1) + "x";

            // 2. WACC Calc
            const ke = CONFIG.RISK_FREE + CONFIG.BETA * CONFIG.MRP;
            const wacc = (inputs.equityPct * ke) + ((1 - inputs.equityPct) * inputs.costDebt * (1 - CONFIG.TAX_RATE));

            // 3. DCF Projection Loop
            let currentEbitda = inputs.ebitda;
            let cumFcf = 0;
            let pvFcfSum = 0;
            state.projections = [];

            for (let i = 1; i <= CONFIG.YEARS; i++) {
                currentEbitda *= (1 + inputs.growth);
                const tax = currentEbitda * CONFIG.TAX_RATE;
                const capex = currentEbitda * 0.05; // Proxy 5%
                const nwc = currentEbitda * 0.02;   // Proxy 2%
                const fcf = currentEbitda - tax - capex - nwc;
                
                const df = 1 / Math.pow((1 + wacc), i);
                const pvFcf = fcf * df;
                
                cumFcf += fcf;
                pvFcfSum += pvFcf;

                state.projections.push({ year: i, ebitda: currentEbitda, fcf, pvFcf });
            }

            // 4. Terminal Value
            const finalFcf = state.projections[CONFIG.YEARS-1].fcf * (1 + CONFIG.TERMINAL_GROWTH);
            const tv = finalFcf / (wacc - CONFIG.TERMINAL_GROWTH);
            const pvTv = tv / Math.pow((1 + wacc), CONFIG.YEARS);
            const ev = pvFcfSum + pvTv;

            // 5. Credit Ratings & SNC
            const leverage = inputs.debt / inputs.ebitda;
            const fccr = (inputs.ebitda * 0.9) / inputs.interest; // 0.9 proxy for cashflow avail
            
            const getRating = (lev, cov) => {
                if (lev < 3.0 && cov > 2.5) return RATING_MAP[3.0];
                if (lev < 4.5 && cov > 1.5) return RATING_MAP[4.0];
                if (lev < 6.0 && cov > 1.1) return RATING_MAP[5.0];
                return RATING_MAP[6.0]; // Default to B- range
            };

            const rating = getRating(leverage, fccr);
            const isSnc = inputs.debt > 100000000;

            // 6. Sponsor / LBO Model
            const futureEbitda = state.projections[CONFIG.YEARS-1].ebitda;
            const exitEv = futureEbitda * inputs.exitMult;
            const cashSweep = cumFcf * 0.6; // 60% conversion to paydown
            const remainingDebt = Math.max(0, inputs.debt - cashSweep);
            const exitEquity = exitEv - remainingDebt;
            const initialEquity = (inputs.ebitda * inputs.entryMult) * inputs.equityPct;
            const moic = exitEquity / initialEquity;
            const irr = Math.pow(moic, 1/CONFIG.YEARS) - 1;

            // --- UI UPDATES ---
            document.getElementById('kpi-ev').innerText = fmtMoney(ev);
            document.getElementById('kpi-wacc').innerText = (wacc*100).toFixed(2) + "%";
            document.getElementById('kpi-rating').innerText = rating;
            
            const sncEl = document.getElementById('kpi-snc');
            sncEl.innerText = isSnc ? "YES (Review)" : "NO";
            sncEl.className = isSnc ? "text-2xl md:text-3xl font-bold text-red-400 mt-1 font-mono" : "text-2xl md:text-3xl font-bold text-white mt-1 font-mono";
            document.getElementById('card-snc').classList.toggle('alert', isSnc);

            // Update DCF Table
            const tbody = document.getElementById('dcfTableBody');
            tbody.innerHTML = "";
            state.projections.forEach(p => {
                tbody.innerHTML += `
                    <tr class="hover:bg-white/5 transition">
                        <td class="py-2 px-4 text-gray-400">Year ${p.year}</td>
                        <td class="py-2 px-4 text-white">${fmtMoney(p.ebitda)}</td>
                        <td class="py-2 px-4 text-cyan-400 font-bold">${fmtMoney(p.fcf)}</td>
                        <td class="py-2 px-4 text-gray-500">${(1/Math.pow(1+wacc, p.year)).toFixed(3)}</td>
                        <td class="py-2 px-4 text-gray-400">${fmtMoney(p.pvFcf)}</td>
                    </tr>`;
            });

            // Update Sponsor Tab
            document.getElementById('sponsor-ebitda').innerText = fmtMoney(futureEbitda);
            document.getElementById('sponsor-netdebt').innerText = fmtMoney(remainingDebt);
            document.getElementById('sponsor-exitequity').innerText = fmtMoney(exitEquity);
            document.getElementById('sponsor-moic').innerText = moic.toFixed(2) + "x";
            const irrEl = document.getElementById('sponsor-irr');
            irrEl.innerText = isNaN(irr) ? "N/A" : (irr*100).toFixed(1) + "%";
            irrEl.className = (irr > 0.20) ? "text-5xl font-bold text-green-400 mt-2 mb-1 tracking-tighter" : "text-5xl font-bold text-cyan-400 mt-2 mb-1 tracking-tighter";

            // Update Credit Stress Table
            const creditBody = document.getElementById('creditTableBody');
            creditBody.innerHTML = "";
            [0, 0.15, 0.30].forEach(shock => {
                const sEbitda = inputs.ebitda * (1 - shock);
                const sLev = inputs.debt / sEbitda;
                const sFccr = (sEbitda * 0.9) / inputs.interest;
                creditBody.innerHTML += `
                    <tr class="border-b border-gray-800">
                        <td class="py-2 px-4 font-bold text-gray-300">Stress -${(shock*100).toFixed(0)}%</td>
                        <td class="py-2 px-4 text-gray-400">${fmtMoney(sEbitda)}</td>
                        <td class="py-2 px-4 text-gray-400">${sLev.toFixed(2)}x</td>
                        <td class="py-2 px-4 text-gray-400">${sFccr.toFixed(2)}x</td>
                        <td class="py-2 px-4 text-cyan-400">${getRating(sLev, sFccr)}</td>
                    </tr>`;
            });

            updateDCFChart();
        }

        // --- CHARTING ---
        function updateDCFChart() {
            const ctx = document.getElementById('dcfChart').getContext('2d');
            if (charts.dcf) charts.dcf.destroy();
            
            charts.dcf = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: state.projections.map(d => `Yr ${d.year}`),
                    datasets: [
                        { label: 'EBITDA', data: state.projections.map(d => d.ebitda), backgroundColor: '#334155', borderRadius: 4 },
                        { label: 'FCF', data: state.projections.map(d => d.fcf), backgroundColor: '#06b6d4', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { display: false, grid: { display: false } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    },
                    plugins: { legend: { display: true, labels: { color: '#cbd5e1' } } }
                }
            });
        }

        // --- SENSITIVITY ---
        function renderSensitivityTable() {
            const inputs = {
                ebitda: parseFloat(document.getElementById('ebitda').value),
                debt: parseFloat(document.getElementById('debt').value),
                entryMult: parseFloat(document.getElementById('entryMult').value),
                equityPct: parseFloat(document.getElementById('equityPct').value) / 100,
                baseGrowth: parseFloat(document.getElementById('growth').value),
                baseExit: parseFloat(document.getElementById('exitMult').value)
            };

            const growthSteps = [-2, -1, 0, 1, 2].map(s => inputs.baseGrowth + s);
            const exitSteps = [-2, -1, 0, 1, 2].map(s => inputs.baseExit + s);

            const table = document.getElementById('sens-table');
            let html = `<thead><tr><th class="p-2 text-gray-500 bg-gray-900 border border-gray-800">Exit \\ Growth</th>`;
            growthSteps.forEach(g => html += `<th class="p-2 text-gray-300 bg-gray-900 border border-gray-800">${g.toFixed(1)}%</th>`);
            html += `</tr></thead><tbody>`;

            exitSteps.forEach(e => {
                html += `<tr><td class="p-2 font-bold text-gray-400 bg-gray-900 border border-gray-800">${e.toFixed(1)}x</td>`;
                growthSteps.forEach(g => {
                    // Quick IRR Calc
                    const gPct = g/100;
                    const futEbitda = inputs.ebitda * Math.pow(1+gPct, CONFIG.YEARS);
                    const initEq = (inputs.ebitda * inputs.entryMult) * inputs.equityPct;
                    
                    // Approx Sweep
                    const approxCumFcf = (futEbitda * 0.6) * CONFIG.YEARS; // Rough proxy
                    const remDebt = Math.max(0, inputs.debt - approxCumFcf*0.5);
                    
                    const exEq = (futEbitda * e) - remDebt;
                    const moic = exEq / initEq;
                    const irr = Math.pow(moic, 1/CONFIG.YEARS) - 1;

                    let color = "text-gray-500";
                    let bg = "";
                    if (irr >= 0.25) { color = "text-green-400 font-bold"; bg = "bg-green-900/30"; }
                    else if (irr >= 0.20) { color = "text-green-200"; bg = "bg-green-900/10"; }
                    else if (irr < 0.10) { color = "text-red-400"; bg = "bg-red-900/20"; }

                    html += `<td class="p-3 border border-gray-800 ${color} ${bg}">${(irr*100).toFixed(1)}%</td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody>`;
            table.innerHTML = html;
        }

        // --- MONTE CARLO ---
        function runMonteCarlo() {
            document.getElementById('mc-loading').classList.remove('hidden');
            
            setTimeout(() => {
                const sims = 5000;
                const vol = document.getElementById('volatility').value / 100;
                const startEbitda = parseFloat(document.getElementById('ebitda').value);
                const debt = parseFloat(document.getElementById('debt').value);
                const growth = parseFloat(document.getElementById('growth').value) / 100;
                const exitMult = parseFloat(document.getElementById('exitMult').value);

                const results = [];
                let debtCovered = 0;

                // Drift = (mu - 0.5 * sigma^2)
                const drift = (growth - 0.5 * vol * vol) * CONFIG.YEARS;
                const sqrtT = Math.sqrt(CONFIG.YEARS);

                for(let i=0; i<sims; i++) {
                    // Box-Muller transform for standard normal Z
                    const u = 1 - Math.random();
                    const v = Math.random();
                    const z = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
                    
                    const shock = vol * sqrtT * z;
                    const endEbitda = startEbitda * Math.exp(drift + shock);
                    const ev = endEbitda * exitMult;
                    
                    results.push(ev);
                    if (ev > debt) debtCovered++;
                }
                
                results.sort((a,b) => a-b);
                
                const mean = results.reduce((a,b)=>a+b, 0) / sims;
                const var95 = results[Math.floor(sims * 0.05)];

                document.getElementById('mc-mean').innerText = fmtMoney(mean);
                document.getElementById('mc-var').innerText = fmtMoney(var95);
                document.getElementById('mc-prob').innerText = ((debtCovered/sims)*100).toFixed(1) + "%";

                renderMcChart(results);
                document.getElementById('mc-loading').classList.add('hidden');
            }, 100);
        }

        function renderMcChart(data) {
            const ctx = document.getElementById('mcChart').getContext('2d');
            if(charts.mc) charts.mc.destroy();

            // Create Bins
            const binCount = 30;
            const min = data[0];
            const max = data[data.length-1];
            const step = (max-min)/binCount;
            const bins = new Array(binCount).fill(0);
            const labels = [];

            for(let i=0; i<binCount; i++) {
                labels.push(fmtMoney(min + (i*step)));
                const limit = min + ((i+1)*step);
                // Simple frequency count
                bins[i] = data.filter(v => v >= (min + i*step) && v < limit).length;
            }

            charts.mc = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Distribution',
                        data: bins,
                        backgroundColor: '#10b981',
                        barPercentage: 1.0,
                        categoryPercentage: 1.0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- SYSTEM FUNCTIONS ---
        function saveScenario() {
            const data = {};
            document.querySelectorAll('input').forEach(el => data[el.id] = el.value);
            localStorage.setItem('adam_state', JSON.stringify(data));
            alert("System State Saved to Neural Memory.");
        }

        function loadScenario() {
            const data = JSON.parse(localStorage.getItem('adam_state'));
            if(!data) return;
            Object.keys(data).forEach(k => {
                const el = document.getElementById(k);
                if(el) el.value = data[k];
            });
            calculate();
        }

        async function exportReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont("courier");
            
            doc.setFillColor(5, 11, 20);
            doc.rect(0, 0, 210, 297, 'F');
            doc.setTextColor(6, 182, 212);
            
            doc.setFontSize(22);
            doc.text("ADAM FINANCIAL ENGINE", 20, 30);
            doc.setFontSize(10);
            doc.setTextColor(200, 200, 200);
            doc.text("QUANTUM ANALYSIS REPORT | " + new Date().toISOString().split('T')[0], 20, 40);
            
            doc.setDrawColor(50, 50, 50);
            doc.line(20, 45, 190, 45);

            let y = 60;
            const addLine = (lbl, val) => {
                doc.text(lbl, 20, y);
                doc.text(val, 150, y);
                y += 10;
            };

            addLine("LTM EBITDA", document.getElementById('disp-ebitda').innerText);
            addLine("IMPLIED EV (DCF)", document.getElementById('kpi-ev').innerText);
            addLine("WACC", document.getElementById('kpi-wacc').innerText);
            addLine("CREDIT RATING", document.getElementById('kpi-rating').innerText);
            
            y += 10;
            doc.setTextColor(6, 182, 212);
            doc.text("SPONSOR RETURNS", 20, y);
            y += 10;
            doc.setTextColor(200, 200, 200);
            addLine("EXIT MULTIPLE", document.getElementById('disp-exitMult').innerText);
            addLine("MOIC", document.getElementById('sponsor-moic').innerText);
            addLine("IRR", document.getElementById('sponsor-irr').innerText);

            doc.save('Adam_Quantum_Report.pdf');
        }

        // Init
        window.onload = calculate;

    </script>
</body>
</html>
