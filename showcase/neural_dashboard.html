<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM v23 | Neural Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <script src="js/mock_data.js"></script>
    <script src="js/app.js"></script>
    <script src="js/nav.js"></script>
    <style>
        /* Custom pulse for active nodes if needed, though Vis.js handles most drawing */
        #viz-canvas {
            width: 100%;
            height: 100%;
            outline: none;
        }
        .vis-tooltip {
            background-color: rgba(15, 23, 42, 0.9) !important;
            border: 1px solid #3b82f6 !important;
            color: #e2e8f0 !important;
            font-family: 'JetBrains Mono', monospace !important;
            font-size: 12px !important;
            padding: 8px !important;
            border-radius: 4px !important;
        }
    </style>
</head>
<body class="bg-grid h-screen flex flex-col overflow-hidden text-slate-200">

    <div class="scan-line"></div>

    <!-- Header -->
    <header class="h-16 border-b border-slate-700/50 flex items-center justify-between px-6 bg-[#0f172a] z-50 relative">
        <div class="flex items-center gap-4">
            <button id="nav-toggle" class="text-slate-400 hover:text-white transition">
                <i class="fas fa-bars"></i>
            </button>
            <div class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse box-shadow-emerald"></div>
            <h1 class="text-xl font-bold tracking-tight">ADAM <span class="text-cyan-400">v23</span> <span class="text-slate-500 font-normal">| Neural Dashboard</span></h1>
        </div>
        <div class="flex gap-6 mono text-xs text-slate-400 hidden md:flex">
            <div>MEM: <span class="text-emerald-400" id="mem-usage">14.2 GB</span></div>
            <div>OPS: <span class="text-cyan-400">2,340 /s</span></div>
            <div>STATUS: <span class="text-emerald-400">ONLINE</span></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col lg:flex-row gap-4 p-4 relative z-10">

        <!-- Sidebar: Active Agents -->
        <aside class="w-full lg:w-64 glass-panel p-4 flex flex-col gap-4 shrink-0 transition-all duration-300" id="sidebar">
            <h2 class="text-xs uppercase tracking-widest text-slate-500 font-bold mb-2">Reasoning Circuits</h2>

            <div class="p-3 bg-slate-800/50 border border-cyan-500/20 rounded cursor-pointer hover:bg-slate-700/50 hover:border-cyan-500/50 transition group" onclick="loadGraph('SNC')">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-sm text-cyan-400 group-hover:text-cyan-300">SNC Analyzer</span>
                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                </div>
                <div class="text-xs text-slate-400">Cyclical Logic: Credit Risk</div>
            </div>

            <div class="p-3 bg-slate-800/50 border border-purple-500/20 rounded cursor-pointer hover:bg-slate-700/50 hover:border-purple-500/50 transition group" onclick="loadGraph('Sentiment')">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-sm text-purple-400 group-hover:text-purple-300">Market Sentiment</span>
                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                </div>
                <div class="text-xs text-slate-400">State: Ingesting News</div>
            </div>

            <div class="p-3 bg-slate-800/50 border border-red-500/20 rounded cursor-pointer hover:bg-slate-700/50 hover:border-red-500/50 transition group" onclick="loadGraph('RedTeam')">
                <div class="flex justify-between items-center mb-1">
                    <span class="font-bold text-sm text-red-400 group-hover:text-red-300">Red Team</span>
                    <span class="w-2 h-2 rounded-full bg-amber-400"></span>
                </div>
                <div class="text-xs text-slate-400">Adversarial Simulator</div>
            </div>

            <div class="mt-auto pt-4 border-t border-slate-700/50">
                 <div class="text-xs text-slate-500 mono mb-1">ACTIVE NODES</div>
                 <div class="h-1 w-full bg-slate-700 rounded overflow-hidden">
                     <div class="h-full bg-cyan-500 w-3/4 animate-pulse"></div>
                 </div>
            </div>
        </aside>

        <!-- Main Visualization Area -->
        <section class="flex-1 glass-panel relative flex flex-col min-h-[400px]">
            <div class="absolute top-4 left-4 z-10 pointer-events-none">
                <h2 id="graph-title" class="text-lg font-bold text-white drop-shadow-md">Select a Circuit</h2>
                <p id="graph-status" class="text-sm text-cyan-400 mono mt-1 drop-shadow-md">Waiting for input...</p>
            </div>

            <!-- Vis.js Container -->
            <div id="viz-canvas"></div>

            <!-- Legend/Controls overlay could go here -->
            <div class="absolute bottom-4 right-4 flex gap-2">
                <button class="p-2 bg-slate-800 text-slate-300 rounded hover:text-white" onclick="network.fit()"><i class="fas fa-compress"></i> Fit</button>
            </div>
        </section>

        <!-- Right Panel: Stream Log -->
        <aside class="w-full lg:w-80 glass-panel flex flex-col shrink-0 h-64 lg:h-auto">
            <div class="p-3 border-b border-slate-700/50 bg-slate-800/30 rounded-t-lg flex justify-between items-center">
                <h2 class="text-xs uppercase tracking-widest text-slate-400 font-bold">Live Thought Stream</h2>
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
            </div>
            <div id="log-container" class="flex-1 overflow-y-auto p-3 mono text-xs space-y-2 scroll-smooth">
                <div class="text-slate-500 border-l-2 border-slate-600 pl-2">[SYSTEM] Neural Dashboard initialized.</div>
            </div>
        </aside>

    </main>

    <script>
        // Graph Data Definitions (Could be in mock_data.js)
        const GRAPHS = {
            'SNC': {
                title: "Shared National Credit (SNC) Analysis",
                nodes: [
                    { id: 1, label: 'START', group: 'start' },
                    { id: 2, label: 'Structure Analysis', group: 'agent' },
                    { id: 3, label: 'Credit Assessment', group: 'agent' },
                    { id: 4, label: 'Risk Critique', group: 'critique' },
                    { id: 5, label: 'Revision', group: 'action' },
                    { id: 6, label: 'Human Approval', group: 'human' },
                    { id: 7, label: 'END', group: 'end' }
                ],
                edges: [
                    { from: 1, to: 2, arrows: 'to' },
                    { from: 2, to: 3, arrows: 'to' },
                    { from: 3, to: 4, arrows: 'to' },
                    { from: 4, to: 5, arrows: 'to', label: 'Reject', color: { color: '#ef4444' } },
                    { from: 5, to: 4, arrows: 'to', label: 'Resubmit' },
                    { from: 4, to: 6, arrows: 'to', label: 'Approve', color: { color: '#10b981' } },
                    { from: 6, to: 7, arrows: 'to' }
                ],
                logMessages: [
                    { msg: "Ingesting credit facility documents...", type: "info" },
                    { msg: "Analyzing covenant compliance structure...", type: "active" },
                    { msg: "Calculating leverage ratios (Net Debt/EBITDA)...", type: "active" },
                    { msg: "CRITIQUE: Lenders seeking higher spread given risk profile.", type: "critique" },
                    { msg: "Revising risk grade recommendation to 'Substandard'...", type: "active" },
                    { msg: "Draft ready for final review.", type: "success" }
                ]
            },
            'Sentiment': {
                title: "Market Sentiment & Contagion Graph",
                nodes: [
                    { id: 1, label: 'News Ingest', group: 'start' },
                    { id: 2, label: 'NLP Analysis', group: 'agent' },
                    { id: 3, label: 'KG Cross-Ref', group: 'agent' },
                    { id: 4, label: 'Contagion Check', group: 'critique' },
                    { id: 5, label: 'Alert Generation', group: 'action' },
                    { id: 6, label: 'Publish', group: 'end' }
                ],
                edges: [
                    { from: 1, to: 2, arrows: 'to' },
                    { from: 2, to: 3, arrows: 'to' },
                    { from: 3, to: 4, arrows: 'to' },
                    { from: 4, to: 5, arrows: 'to', label: 'High Risk' },
                    { from: 4, to: 1, arrows: 'to', label: 'Low Risk', dashes: true },
                    { from: 5, to: 6, arrows: 'to' }
                ],
                logMessages: [
                    { msg: "Scanning Bloomberg/Reuters feeds...", type: "info" },
                    { msg: "Detected negative sentiment spike: TECH sector.", type: "active" },
                    { msg: "Mapping supply chain dependencies for NVDA...", type: "active" },
                    { msg: "CRITIQUE: Verify source credibility.", type: "critique" },
                    { msg: "Confirmed signal. Generating alert.", type: "success" }
                ]
            },
            'RedTeam': {
                title: "Adversarial Red Team Simulation",
                nodes: [
                    { id: 1, label: 'Scenario Gen', group: 'start' },
                    { id: 2, label: 'Attack Vector', group: 'critique' },
                    { id: 3, label: 'System Defense', group: 'agent' },
                    { id: 4, label: 'Impact Analysis', group: 'agent' },
                    { id: 5, label: 'Report', group: 'end' }
                ],
                edges: [
                    { from: 1, to: 2, arrows: 'to' },
                    { from: 2, to: 3, arrows: 'to' },
                    { from: 3, to: 4, arrows: 'to' },
                    { from: 4, to: 2, arrows: 'to', label: 'Iterate' },
                    { from: 4, to: 5, arrows: 'to', label: 'Finalize' }
                ],
                logMessages: [
                    { msg: "Generating Black Swan event: Cyber Attack...", type: "info" },
                    { msg: "Simulating liquidity freeze in bond markets.", type: "critique" },
                    { msg: "Defense Protocol Alpha activated.", type: "active" },
                    { msg: "Impact: 15% drop in collateral value.", type: "active" }
                ]
            }
        };

        let network = null;
        let simulationInterval = null;

        // Vis.js Options
        const options = {
            nodes: {
                shape: 'dot',
                size: 20,
                font: {
                    face: 'JetBrains Mono',
                    color: '#e2e8f0',
                    size: 14
                },
                borderWidth: 2,
                shadow: true
            },
            edges: {
                width: 2,
                color: { color: '#64748b', highlight: '#22d3ee' },
                smooth: {
                    type: 'curvedCW',
                    roundness: 0.2
                },
                shadow: true
            },
            groups: {
                start: { color: { background: '#10b981', border: '#059669' }, size: 25 }, // Emerald
                end: { color: { background: '#64748b', border: '#475569' }, size: 25 },   // Slate
                agent: { color: { background: '#3b82f6', border: '#2563eb' } },            // Blue
                critique: { color: { background: '#ef4444', border: '#dc2626' } },         // Red
                action: { color: { background: '#f59e0b', border: '#d97706' } },           // Amber
                human: { color: { background: '#8b5cf6', border: '#7c3aed' } }             // Violet
            },
            physics: {
                stabilization: false,
                barnesHut: {
                    gravitationalConstant: -2000,
                    springConstant: 0.04,
                    springLength: 95
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200
            }
        };

        function loadGraph(key) {
            const data = GRAPHS[key];
            if(!data) return;

            document.getElementById('graph-title').innerText = data.title;
            document.getElementById('graph-status').innerText = "Simulation Running...";

            const container = document.getElementById('viz-canvas');

            // Transform nodes for Vis.js
            const nodes = new vis.DataSet(data.nodes);
            const edges = new vis.DataSet(data.edges);

            if(network) network.destroy();

            network = new vis.Network(container, { nodes, edges }, options);

            // Start Simulation Log
            runLogSimulation(data.logMessages);

            // Pulse animation logic could go here by updating node properties
            startPulseAnimation(nodes);
        }

        function runLogSimulation(messages) {
            const logContainer = document.getElementById('log-container');
            if(simulationInterval) clearInterval(simulationInterval);

            let index = 0;
            simulationInterval = setInterval(() => {
                if(index >= messages.length) {
                    index = 0; // Loop
                    addLogEntry("--- Cycle Complete ---", "info");
                }

                const m = messages[index];
                addLogEntry(m.msg, m.type);
                index++;
            }, 2000);
        }

        function addLogEntry(msg, type) {
            const div = document.createElement('div');
            const time = new Date().toISOString().split('T')[1].split('.')[0];

            let colorClass = "text-slate-400";
            let borderClass = "border-transparent";

            if(type === 'active') { colorClass = "text-cyan-400"; borderClass = "border-cyan-500"; }
            if(type === 'critique') { colorClass = "text-red-400"; borderClass = "border-red-500"; }
            if(type === 'success') { colorClass = "text-emerald-400"; borderClass = "border-emerald-500"; }

            div.className = `${colorClass} border-l-2 ${borderClass} pl-2 text-xs font-mono animate-in fade-in slide-in-from-left-2 duration-300`;
            div.innerHTML = `<span class="opacity-50">[${time}]</span> ${msg}`;

            const container = document.getElementById('log-container');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function startPulseAnimation(nodes) {
             // Simple visual effect: Randomly scale nodes slightly to simulate "thinking"
             setInterval(() => {
                 const allNodes = nodes.get();
                 if(allNodes.length === 0) return;
                 const randomNode = allNodes[Math.floor(Math.random() * allNodes.length)];

                 // We can't easily animate size in Vis.js without updating dataset, which triggers redraw.
                 // Use highlighting instead
                 network.selectNodes([randomNode.id], false);
                 setTimeout(() => {
                     network.unselectAll();
                 }, 500);
             }, 1000);
        }

        // Initialize with default
        window.addEventListener('load', () => {
            // Check DataManager
            window.dataManager.init().then(() => {
                const stats = window.dataManager.getSystemStats();
                if(stats && stats.memory_usage) {
                    document.getElementById('mem-usage').innerText = stats.memory_usage + " GB";
                }
                loadGraph('SNC');
            });

            // Nav Toggle
            document.getElementById('nav-toggle').addEventListener('click', () => {
                window.location.href = 'index.html'; // Or toggle sidebar visibility
            });
        });

    </script>
</body>
</html>
