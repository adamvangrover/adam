<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM Analyst OS | Unified Architecture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-dark: #020408;
            --cyan-glow: #00f0ff;
            --purple-glow: #bc13fe;
            --green-glow: #10b981;
            --panel-glass: rgba(10, 15, 30, 0.95);
            --dock-glass: rgba(5, 10, 20, 0.8);
            --grid-line: rgba(0, 240, 255, 0.05);
        }

        body {
            background-color: var(--bg-dark);
            color: #e2e8f0;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            background-image:
                linear-gradient(rgba(2, 4, 8, 0.9), rgba(2, 4, 8, 0.9)),
                url('https://images.unsplash.com/photo-1642427749670-f20e2e76ed8c?q=80&w=2000&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }

        /* --- OS UI ELEMENTS --- */

        .os-window {
            position: absolute;
            background: #020408;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            border-radius: 6px;
            overflow: hidden;
            resize: both;
            min-width: 400px; min-height: 300px;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .os-window.active {
            border-color: var(--cyan-glow);
            z-index: 50;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.15);
        }

        .window-bar {
            background: #0f172a;
            padding: 6px 10px;
            display: flex; justify-content: space-between; items-center;
            cursor: move;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            user-select: none;
        }

        .window-content {
            flex-grow: 1;
            position: relative;
            overflow: auto;
            background: rgba(2, 4, 8, 0.95);
        }

        /* Dock */
        .dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--dock-glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 10px 20px;
            display: flex; gap: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .dock-item {
            width: 48px; height: 48px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            display: flex; justify-content: center; items-center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .dock-item:hover {
            transform: translateY(-5px) scale(1.1);
            background: rgba(255,255,255,0.1);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
        }
        .dock-item::after {
            content: attr(data-title);
            position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white;
            padding: 4px 8px; border-radius: 4px; font-size: 10px;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
            white-space: nowrap;
        }
        .dock-item:hover::after { opacity: 1; }

        .app-dot {
            width: 4px; height: 4px; background: var(--cyan-glow); border-radius: 50%;
            position: absolute; bottom: -6px; opacity: 0;
        }
        .app-dot.running { opacity: 1; }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- APP SPECIFIC STYLES --- */
        .glass-panel {
            background: rgba(10, 15, 30, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        input[type="number"], select, input[type="text"] {
            background: #050a14;
            border: 1px solid #1e293b;
            color: var(--cyan-glow);
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
            font-size: 0.75rem;
        }
        input:focus, select:focus {
            border-color: var(--cyan-glow);
            box-shadow: 0 0 5px rgba(0, 240, 255, 0.2);
            outline: none;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--cyan-glow); }

        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        th { background: rgba(0, 240, 255, 0.05); color: var(--cyan-glow); font-weight: normal; text-transform: uppercase; letter-spacing: 1px; padding: 4px;}
        td { border-bottom: 1px solid #1e293b; padding: 4px; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden text-xs select-none">

    <!-- Top Bar -->
    <div class="fixed top-0 left-0 w-full h-8 bg-black/60 backdrop-blur flex justify-between items-center px-4 z-40 border-b border-white/5">
        <div class="flex items-center gap-4 text-[10px] font-bold tracking-widest text-gray-400">
            <span class="text-white">ADAM OS <span class="text-cyan-400">v25.5-UNIFIED</span></span>
            <span class="hover:text-white cursor-pointer">FILE</span>
            <span class="hover:text-white cursor-pointer">EDIT</span>
            <span class="hover:text-white cursor-pointer">VIEW</span>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 px-2 py-0.5 bg-green-900/20 border border-green-500/30 rounded text-[10px] text-green-400" title="Running Locally">
                <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                SECURE_CORE
            </div>
            <div class="text-[10px] text-gray-400 font-mono" id="clock">00:00</div>
        </div>
    </div>

    <!-- Desktop Area -->
    <div id="desktop" class="w-full h-full pt-8 pb-24 relative">
        <!-- Windows injected here -->
    </div>

    <!-- Dock -->
    <div class="dock">
        <div class="dock-item" onclick="WindowManager.open('mission', 'Mission Control', 800, 500)" data-title="Mission Control">
            <i data-lucide="cpu" class="text-blue-400 w-6 h-6"></i>
            <div class="app-dot" id="dot-mission"></div>
        </div>
        <div class="dock-item" onclick="WindowManager.open('dcf', 'DCF Valuator Pro', 1000, 700)" data-title="DCF Valuator">
            <i data-lucide="bar-chart-2" class="text-cyan-400 w-6 h-6"></i>
            <div class="app-dot" id="dot-dcf"></div>
        </div>
        <div class="dock-item" onclick="WindowManager.open('market', 'Market Radar', 900, 600)" data-title="Market Radar">
            <i data-lucide="radar" class="text-purple-400 w-6 h-6"></i>
            <div class="app-dot" id="dot-market"></div>
        </div>
        <div class="w-[1px] h-8 bg-white/10 mx-2"></div>
        <div class="dock-item" onclick="WindowManager.openNotepad()" data-title="Secure Notepad">
            <i data-lucide="sticky-note" class="text-yellow-400 w-6 h-6"></i>
        </div>
        <div class="dock-item" onclick="location.reload()" data-title="Reboot System">
            <i data-lucide="power" class="text-red-400 w-6 h-6"></i>
        </div>
    </div>


    <!-- ================= TEMPLATES ================= -->

    <!-- TEMPLATE: MISSION CONTROL -->
    <template id="tpl-mission">
        <div class="p-4 h-full flex flex-col gap-4 text-gray-300">
            <div class="grid grid-cols-2 gap-4">
                <div class="glass-panel p-4 rounded bg-blue-900/10 border-blue-500/30">
                    <h3 class="text-blue-400 font-bold mb-2 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4"></i> SYSTEM STATUS</h3>
                    <div class="space-y-2 font-mono text-[10px]">
                        <div class="flex justify-between"><span>CORE_KERNEL</span><span class="text-green-400">ONLINE</span></div>
                        <div class="flex justify-between"><span>DCF_ENGINE</span><span class="text-green-400">READY</span></div>
                        <div class="flex justify-between"><span>MEMORY_USAGE</span><span class="text-yellow-400">128MB</span></div>
                        <div class="flex justify-between"><span>ENCRYPTION</span><span class="text-cyan-400">AES-256</span></div>
                    </div>
                </div>
                <div class="glass-panel p-4 rounded bg-purple-900/10 border-purple-500/30">
                    <h3 class="text-purple-400 font-bold mb-2 flex items-center gap-2"><i data-lucide="brain-circuit" class="w-4 h-4"></i> ACTIVE AGENTS</h3>
                    <div class="space-y-2 font-mono text-[10px]">
                        <div class="flex justify-between"><span>ANALYST_NODE</span><span class="text-white">IDLE</span></div>
                        <div class="flex justify-between"><span>RISK_CONTROLLER</span><span class="text-green-400">MONITORING</span></div>
                        <div class="flex justify-between"><span>MARKET_SCANNER</span><span class="text-blue-400">SCANNING</span></div>
                    </div>
                </div>
            </div>
            <div class="glass-panel flex-grow p-4 rounded relative overflow-hidden">
                <div class="absolute inset-0 bg-black/50 z-0"></div>
                <div class="relative z-10 font-mono text-[10px] text-gray-500 h-full overflow-y-auto" id="system-log">
                    <div class="text-green-500">>> SYSTEM INITIALIZED AT <span class="time-now"></span></div>
                    <div class="text-gray-400">>> LOADED MODULE: CORE.FINANCE.DCF</div>
                    <div class="text-gray-400">>> LOADED MODULE: CORE.MARKET.RADAR</div>
                    <div class="text-gray-400">>> WAITING FOR USER INPUT...</div>
                </div>
            </div>
        </div>
    </template>

    <!-- TEMPLATE: MARKET RADAR -->
    <template id="tpl-market">
        <div class="p-4 h-full flex flex-col gap-4">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-bold text-purple-400">MARKET CONTEXT</h2>
                <div class="text-[10px] text-gray-500">LIVE FEED (SIMULATED)</div>
            </div>
            <div class="grid grid-cols-3 gap-2 h-20">
                <div class="bg-gray-800/50 p-2 rounded flex flex-col justify-center items-center border border-gray-700">
                    <div class="text-xs text-gray-400">S&P 500</div>
                    <div class="text-lg font-bold text-green-400">4,785.20</div>
                    <div class="text-[9px] text-green-500">+1.2%</div>
                </div>
                <div class="bg-gray-800/50 p-2 rounded flex flex-col justify-center items-center border border-gray-700">
                    <div class="text-xs text-gray-400">NASDAQ</div>
                    <div class="text-lg font-bold text-green-400">15,120.50</div>
                    <div class="text-[9px] text-green-500">+1.5%</div>
                </div>
                <div class="bg-gray-800/50 p-2 rounded flex flex-col justify-center items-center border border-gray-700">
                    <div class="text-xs text-gray-400">US 10Y</div>
                    <div class="text-lg font-bold text-red-400">4.02%</div>
                    <div class="text-[9px] text-red-500">+5bps</div>
                </div>
            </div>
            <div class="glass-panel flex-grow p-4 rounded">
                <canvas class="market-chart"></canvas>
            </div>
        </div>
    </template>


    <!-- TEMPLATE: DCF VALUATOR (The Big One) -->
    <template id="tpl-dcf">
        <div class="h-full flex flex-col p-4 overflow-hidden">
            <!-- Toolbar -->
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <div class="flex items-center gap-2">
                    <div class="text-xs font-bold text-cyan-400 border border-cyan-500/30 px-2 py-1 rounded bg-cyan-900/20">
                        MODEL: 3Y-HIST / 7Y-FWD
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="btn-calc px-3 py-1 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded text-[10px] flex items-center gap-1 transition">
                        <i data-lucide="play" class="w-3 h-3"></i> RECALCULATE
                    </button>
                    <button class="btn-export px-3 py-1 bg-gray-800 hover:bg-gray-700 text-gray-300 font-bold rounded text-[10px] flex items-center gap-1 transition">
                        <i data-lucide="download" class="w-3 h-3"></i> CSV
                    </button>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid grid-cols-12 gap-4 flex-grow overflow-hidden">

                <!-- Sidebar: Inputs -->
                <aside class="col-span-4 space-y-3 overflow-y-auto pr-2 custom-scroll h-full pb-10">

                    <!-- 1. Historical Inputs (New Requirement) -->
                    <div class="glass-panel p-3 rounded border-l-2 border-l-blue-500">
                        <div class="text-[10px] text-blue-400 mb-2 uppercase font-bold flex justify-between">
                            <span>1. Historicals (Years -3 to -1)</span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 mb-1 text-[9px] text-gray-500 text-center">
                            <div>Metric</div><div>Y-3</div><div>Y-2</div><div>Y-1 (LTM)</div>
                        </div>
                        <!-- Revenue History -->
                        <div class="grid grid-cols-4 gap-2 items-center mb-2">
                            <label class="text-[9px] text-gray-400">Rev</label>
                            <input type="number" class="inp-hist-rev-3 w-full px-1 py-0.5 rounded text-right" value="800">
                            <input type="number" class="inp-hist-rev-2 w-full px-1 py-0.5 rounded text-right" value="900">
                            <input type="number" class="inp-hist-rev-1 w-full px-1 py-0.5 rounded text-right" value="1000">
                        </div>
                         <!-- EBITDA History -->
                         <div class="grid grid-cols-4 gap-2 items-center">
                            <label class="text-[9px] text-gray-400">EBITDA</label>
                            <input type="number" class="inp-hist-ebitda-3 w-full px-1 py-0.5 rounded text-right" value="180">
                            <input type="number" class="inp-hist-ebitda-2 w-full px-1 py-0.5 rounded text-right" value="210">
                            <input type="number" class="inp-hist-ebitda-1 w-full px-1 py-0.5 rounded text-right" value="250">
                        </div>
                    </div>

                    <!-- 2. Projection Assumptions (Year-by-Year) -->
                    <div class="glass-panel p-3 rounded border-l-2 border-l-cyan-500">
                        <div class="text-[10px] text-cyan-400 mb-2 uppercase font-bold flex justify-between">
                            <span>2. Forecast Drivers (Y1 - Y7)</span>
                        </div>
                        <div class="grid grid-cols-4 gap-1 mb-1 text-[8px] text-gray-500 text-center font-mono">
                            <div>YR</div><div>GROWTH%</div><div>MARGIN%</div><div>CAPEX%</div>
                        </div>
                        <div class="space-y-1" id="forecast-grid">
                            <!-- Generated Rows Y1-Y7 -->
                            <div class="grid grid-cols-4 gap-1 items-center">
                                <div class="text-[9px] text-gray-400 text-center">Y1</div>
                                <input type="number" class="inp-growth-1 w-full px-1 py-0.5 rounded text-right bg-cyan-900/10 border-cyan-500/20" value="5.0" step="0.1">
                                <input type="number" class="inp-margin-1 w-full px-1 py-0.5 rounded text-right bg-purple-900/10 border-purple-500/20" value="26.0" step="0.5">
                                <input type="number" class="inp-capex-1 w-full px-1 py-0.5 rounded text-right" value="3.5" step="0.1">
                            </div>
                            <div class="grid grid-cols-4 gap-1 items-center">
                                <div class="text-[9px] text-gray-400 text-center">Y2</div>
                                <input type="number" class="inp-growth-2 w-full px-1 py-0.5 rounded text-right bg-cyan-900/10 border-cyan-500/20" value="5.5" step="0.1">
                                <input type="number" class="inp-margin-2 w-full px-1 py-0.5 rounded text-right bg-purple-900/10 border-purple-500/20" value="26.5" step="0.5">
                                <input type="number" class="inp-capex-2 w-full px-1 py-0.5 rounded text-right" value="3.5" step="0.1">
                            </div>
                            <div class="grid grid-cols-4 gap-1 items-center">
                                <div class="text-[9px] text-gray-400 text-center">Y3</div>
                                <input type="number" class="inp-growth-3 w-full px-1 py-0.5 rounded text-right bg-cyan-900/10 border-cyan-500/20" value="6.0" step="0.1">
                                <input type="number" class="inp-margin-3 w-full px-1 py-0.5 rounded text-right bg-purple-900/10 border-purple-500/20" value="27.0" step="0.5">
                                <input type="number" class="inp-capex-3 w-full px-1 py-0.5 rounded text-right" value="3.5" step="0.1">
                            </div>
                            <div class="grid grid-cols-4 gap-1 items-center">
                                <div class="text-[9px] text-gray-400 text-center">Y4</div>
                                <input type="number" class="inp-growth-4 w-full px-1 py-0.5 rounded text-right bg-cyan-900/10 border-cyan-500/20" value="5.5" step="0.1">
                                <input type="number" class="inp-margin-4 w-full px-1 py-0.5 rounded text-right bg-purple-900/10 border-purple-500/20" value="27.5" step="0.5">
                                <input type="number" class="inp-capex-4 w-full px-1 py-0.5 rounded text-right" value="3.5" step="0.1">
                            </div>
                            <div class="grid grid-cols-4 gap-1 items-center">
                                <div class="text-[9px] text-gray-400 text-center">Y5</div>
                                <input type="number" class="inp-growth-5 w-full px-1 py-0.5 rounded text-right bg-cyan-900/10 border-cyan-500/20" value="5.0" step="0.1">
                                <input type="number" class="inp-margin-5 w-full px-1 py-0.5 rounded text-right bg-purple-900/10 border-purple-500/20" value="28.0" step="0.5">
                                <input type="number" class="inp-capex-5 w-full px-1 py-0.5 rounded text-right" value="3.5" step="0.1">
                            </div>
                            <div class="grid grid-cols-4 gap-1 items-center">
                                <div class="text-[9px] text-gray-400 text-center">Y6</div>
                                <input type="number" class="inp-growth-6 w-full px-1 py-0.5 rounded text-right bg-cyan-900/10 border-cyan-500/20" value="4.5" step="0.1">
                                <input type="number" class="inp-margin-6 w-full px-1 py-0.5 rounded text-right bg-purple-900/10 border-purple-500/20" value="28.0" step="0.5">
                                <input type="number" class="inp-capex-6 w-full px-1 py-0.5 rounded text-right" value="3.5" step="0.1">
                            </div>
                            <div class="grid grid-cols-4 gap-1 items-center">
                                <div class="text-[9px] text-gray-400 text-center">Y7</div>
                                <input type="number" class="inp-growth-7 w-full px-1 py-0.5 rounded text-right bg-cyan-900/10 border-cyan-500/20" value="4.0" step="0.1">
                                <input type="number" class="inp-margin-7 w-full px-1 py-0.5 rounded text-right bg-purple-900/10 border-purple-500/20" value="28.0" step="0.5">
                                <input type="number" class="inp-capex-7 w-full px-1 py-0.5 rounded text-right" value="3.5" step="0.1">
                            </div>
                            <div class="flex justify-between items-center pt-2 border-t border-white/10">
                                <label class="text-[10px] text-gray-400">Tax Rate %</label>
                                <input type="number" class="inp-tax w-16 px-1 py-0.5 rounded text-right" value="21.0">
                            </div>
                        </div>
                    </div>

                    <!-- 3. WACC & Structure -->
                    <div class="glass-panel p-3 rounded border-l-2 border-l-purple-500">
                         <div class="text-[10px] text-purple-400 mb-2 uppercase font-bold">
                            <span>3. WACC & Terminal</span>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <label class="text-[10px] text-gray-400">Risk Free Rate</label>
                                <input type="number" class="inp-rf w-16 px-1 py-0.5 rounded text-right" value="4.0" step="0.1">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-[10px] text-gray-400">Equity Risk Prem</label>
                                <input type="number" class="inp-erp w-16 px-1 py-0.5 rounded text-right" value="6.0" step="0.1">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-[10px] text-gray-400">Beta</label>
                                <input type="number" class="inp-beta w-16 px-1 py-0.5 rounded text-right" value="1.2" step="0.05">
                            </div>
                            <div class="h-[1px] bg-white/10 my-1"></div>
                            <div class="flex justify-between items-center">
                                <label class="text-[10px] text-gray-400 font-bold">Terminal Growth %</label>
                                <input type="number" class="inp-tgr w-16 px-1 py-0.5 rounded text-right bg-purple-900/20 border-purple-500/30" value="2.5" step="0.1">
                            </div>
                        </div>
                    </div>

                     <!-- 4. Cap Structure -->
                     <div class="glass-panel p-3 rounded">
                        <div class="space-y-2">
                           <div class="flex justify-between items-center">
                               <label class="text-[10px] text-gray-400">Net Debt ($M)</label>
                               <input type="number" class="inp-debt w-16 px-1 py-0.5 rounded text-right" value="450">
                           </div>
                           <div class="flex justify-between items-center">
                               <label class="text-[10px] text-gray-400">Shares (M)</label>
                               <input type="number" class="inp-shares w-16 px-1 py-0.5 rounded text-right" value="100">
                           </div>
                       </div>
                   </div>

                </aside>

                <!-- Main: Outputs -->
                <main class="col-span-8 flex flex-col gap-3 overflow-y-auto pr-2 custom-scroll pb-10">

                    <!-- Scorecards -->
                    <div class="grid grid-cols-4 gap-3">
                        <div class="glass-panel p-2 rounded flex flex-col justify-center">
                            <div class="text-[9px] text-gray-500 uppercase">Enterprise Value</div>
                            <div class="text-lg font-bold text-white mt-1 font-mono val-ev">$0.0M</div>
                        </div>
                        <div class="glass-panel p-2 rounded flex flex-col justify-center">
                            <div class="text-[9px] text-gray-500 uppercase">Equity Value</div>
                            <div class="text-lg font-bold text-white mt-1 font-mono val-eq">$0.0M</div>
                        </div>
                        <div class="glass-panel p-2 rounded border-cyan-500/30 bg-cyan-900/10 flex flex-col justify-center">
                            <div class="text-[9px] text-cyan-400 uppercase font-bold">Share Price</div>
                            <div class="text-xl font-bold text-cyan-300 mt-1 font-mono val-share">$0.00</div>
                        </div>
                         <div class="glass-panel p-2 rounded flex flex-col justify-center">
                            <div class="text-[9px] text-gray-500 uppercase">Implied WACC</div>
                            <div class="text-lg font-bold text-white mt-1 font-mono val-wacc">0.0%</div>
                        </div>
                    </div>

                    <!-- 10 Year Output Table -->
                    <div class="glass-panel p-3 rounded overflow-x-auto">
                        <h3 class="text-xs font-bold text-gray-400 mb-2">10-Year Trajectory (3 Hist + 7 Proj)</h3>
                        <table class="w-full text-[9px] font-mono">
                            <thead>
                                <tr class="text-gray-500 border-b border-gray-700">
                                    <th class="text-left pl-2">Period</th>
                                    <th class="text-right text-blue-400">Y-3</th>
                                    <th class="text-right text-blue-400">Y-2</th>
                                    <th class="text-right text-blue-400">Y-1</th>
                                    <th class="text-right text-cyan-400">Y1</th>
                                    <th class="text-right text-cyan-400">Y2</th>
                                    <th class="text-right text-cyan-400">Y3</th>
                                    <th class="text-right text-cyan-400">Y4</th>
                                    <th class="text-right text-cyan-400">Y5</th>
                                    <th class="text-right text-cyan-400">Y6</th>
                                    <th class="text-right text-cyan-400">Y7</th>
                                </tr>
                            </thead>
                            <tbody class="tbody-dcf">
                                <!-- JS Injected -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Chart -->
                    <div class="glass-panel p-3 rounded h-64 relative">
                        <canvas class="chart-dcf"></canvas>
                    </div>

                </main>
            </div>
        </div>
    </template>

    <script>
        lucide.createIcons();
        let zIndexCounter = 100;

        /**
         * Window Manager
         * Handles creation, dragging, and template instantiation
         */
        const WindowManager = {
            open: function(id, title, w, h) {
                // Check if already open
                let win = document.getElementById(`win-${id}`);
                if (win) {
                    this.bringToFront(win);
                    return;
                }

                // Create Window Shell
                win = document.createElement('div');
                win.id = `win-${id}`;
                win.className = 'os-window active';
                win.style.width = w + 'px';
                win.style.height = h + 'px';

                // Cascade position
                const count = document.querySelectorAll('.os-window').length;
                win.style.top = (60 + (count * 30)) + 'px';
                win.style.left = (60 + (count * 30)) + 'px';
                win.style.zIndex = ++zIndexCounter;

                // Header
                const header = `
                    <div class="window-bar" onmousedown="WindowManager.startDrag(event, '${id}')">
                        <div class="flex items-center gap-2">
                             <i data-lucide="app-window" class="w-3 h-3 text-gray-500"></i>
                             <span class="text-xs font-bold text-gray-300 tracking-wider">${title}</span>
                        </div>
                        <div class="flex gap-2 items-center">
                            <div onclick="WindowManager.close('${id}')" class="w-3 h-3 rounded-full bg-red-500/50 hover:bg-red-500 cursor-pointer border border-red-500/30"></div>
                        </div>
                    </div>
                `;

                // Content from Template
                const template = document.getElementById(`tpl-${id}`);
                if(!template) { console.error("Template not found:", id); return; }

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'window-content';
                contentWrapper.appendChild(template.content.cloneNode(true));

                win.innerHTML = header;
                win.appendChild(contentWrapper);
                document.getElementById('desktop').appendChild(win);

                // Activate Dot
                const dot = document.getElementById(`dot-${id}`);
                if(dot) dot.classList.add('running');

                // Bind events for this specific window instance
                win.onmousedown = () => this.bringToFront(win);
                lucide.createIcons();

                // Initialize App Logic based on ID
                if(id === 'dcf') new DCFApp(contentWrapper);
                if(id === 'market') new MarketApp(contentWrapper);
                if(id === 'mission') {
                    contentWrapper.querySelector('.time-now').innerText = new Date().toLocaleTimeString();
                }
            },

            close: function(id) {
                const win = document.getElementById(`win-${id}`);
                if(win) win.remove();
                const dot = document.getElementById(`dot-${id}`);
                if(dot) dot.classList.remove('running');
            },

            bringToFront: function(el) {
                document.querySelectorAll('.os-window').forEach(w => w.classList.remove('active'));
                el.classList.add('active');
                el.style.zIndex = ++zIndexCounter;
            },

            // Dragging Logic
            isDragging: false,
            dragOffset: {x:0, y:0},
            currentWin: null,

            startDrag: function(e, id) {
                this.isDragging = true;
                this.currentWin = document.getElementById(`win-${id}`);
                this.bringToFront(this.currentWin);
                const rect = this.currentWin.getBoundingClientRect();
                this.dragOffset.x = e.clientX - rect.left;
                this.dragOffset.y = e.clientY - rect.top;

                const overlay = document.createElement('div');
                overlay.id = 'drag-overlay';
                overlay.style.position = 'fixed'; overlay.style.inset = '0'; overlay.style.zIndex = '9999'; overlay.style.cursor = 'move';
                document.body.appendChild(overlay);
            },

            openNotepad: function() {
                // Simple version logic
                this.open('notepad', 'Notepad', 400, 300);
                // (Assuming we added a template for it, or just generic... leaving simple for now as requested DCF is priority)
            }
        };

        document.addEventListener('mousemove', (e) => {
            if (!WindowManager.isDragging || !WindowManager.currentWin) return;
            let x = e.clientX - WindowManager.dragOffset.x;
            let y = e.clientY - WindowManager.dragOffset.y;
            if(y < 32) y = 32;
            WindowManager.currentWin.style.left = x + 'px';
            WindowManager.currentWin.style.top = y + 'px';
        });

        document.addEventListener('mouseup', () => {
            if(WindowManager.isDragging) {
                WindowManager.isDragging = false;
                WindowManager.currentWin = null;
                const ov = document.getElementById('drag-overlay');
                if(ov) ov.remove();
            }
        });


        /**
         * DCF APP LOGIC (Scoped)
         */
        class DCFApp {
            constructor(root) {
                this.root = root;
                this.chart = null;

                // Bind buttons
                root.querySelector('.btn-calc').addEventListener('click', () => this.run());
                root.querySelector('.btn-export').addEventListener('click', () => this.exportCSV());

                // Bind inputs to auto-calc
                root.querySelectorAll('input').forEach(inp => {
                    inp.addEventListener('change', () => this.run());
                });

                // Initial Run
                this.run();
            }

            getVal(selector) {
                return parseFloat(this.root.querySelector(selector).value) || 0;
            }

            fmt(n) { return n.toLocaleString(undefined, {minimumFractionDigits:1, maximumFractionDigits:1}); }

            run() {
                // 1. Inputs
                // Historicals
                const hist = [
                    { yr: -3, rev: this.getVal('.inp-hist-rev-3'), ebitda: this.getVal('.inp-hist-ebitda-3') },
                    { yr: -2, rev: this.getVal('.inp-hist-rev-2'), ebitda: this.getVal('.inp-hist-ebitda-2') },
                    { yr: -1, rev: this.getVal('.inp-hist-rev-1'), ebitda: this.getVal('.inp-hist-ebitda-1') }
                ];

                // Assumptions
                const taxRate = this.getVal('.inp-tax') / 100;

                // WACC
                const rf = this.getVal('.inp-rf') / 100;
                const erp = this.getVal('.inp-erp') / 100;
                const beta = this.getVal('.inp-beta');
                const costDebt = 0.065; // Fixed assumption for simplicity or add input
                const debtWeight = 0.30;
                const ke = rf + (beta * erp);
                const kd = costDebt * (1 - taxRate);
                const wacc = (ke * (1-debtWeight)) + (kd * debtWeight);

                const tgr = this.getVal('.inp-tgr') / 100;
                const netDebt = this.getVal('.inp-debt');
                const shares = this.getVal('.inp-shares');

                // 2. Projections (7 Years)
                let proj = [];
                let lastRev = hist[2].rev; // LTM Rev

                for(let i=1; i<=7; i++) {
                    // Get year specific drivers
                    const growth = this.getVal(`.inp-growth-${i}`) / 100;
                    const margin = this.getVal(`.inp-margin-${i}`) / 100;
                    const capexPct = this.getVal(`.inp-capex-${i}`) / 100;

                    lastRev = lastRev * (1 + growth);
                    const ebitda = lastRev * margin;
                    const da = ebitda * 0.15; // Assume 15% D&A
                    const ebit = ebitda - da;
                    const tax = ebit * taxRate;
                    const nopat = ebit - tax;
                    const capex = lastRev * capexPct;
                    const nwc = lastRev * 0.01; // 1% NWC change
                    const ufcf = nopat + da - capex - nwc;

                    proj.push({
                        yr: i,
                        rev: lastRev,
                        ebitda: ebitda,
                        ufcf: ufcf
                    });
                }

                // 3. Valuation
                let pvFcf = 0;
                proj.forEach(p => {
                    pvFcf += p.ufcf / Math.pow(1 + wacc, p.yr);
                });

                // Terminal Value
                const termFcf = proj[6].ufcf * (1 + tgr);
                const tv = termFcf / (wacc - tgr);
                const pvTv = tv / Math.pow(1 + wacc, 7);
                const ev = pvFcf + pvTv;
                const eq = ev - netDebt;
                const sharePrice = eq / shares;

                // 4. Update UI
                this.root.querySelector('.val-ev').innerText = `$${this.fmt(ev)}M`;
                this.root.querySelector('.val-eq').innerText = `$${this.fmt(eq)}M`;
                this.root.querySelector('.val-share').innerText = `$${sharePrice.toFixed(2)}`;
                this.root.querySelector('.val-wacc').innerText = `${(wacc*100).toFixed(1)}%`;

                // Update Table
                const tbody = this.root.querySelector('.tbody-dcf');
                let html = '';

                // Revenue Row
                html += `<tr><td class="pl-2 text-gray-500">Revenue</td>`;
                hist.forEach(h => html += `<td class="text-right text-gray-400">${this.fmt(h.rev)}</td>`);
                proj.forEach(p => html += `<td class="text-right text-white">${this.fmt(p.rev)}</td>`);
                html += `</tr>`;

                // EBITDA Row
                html += `<tr><td class="pl-2 text-gray-500">EBITDA</td>`;
                hist.forEach(h => html += `<td class="text-right text-gray-400">${this.fmt(h.ebitda)}</td>`);
                proj.forEach(p => html += `<td class="text-right text-white">${this.fmt(p.ebitda)}</td>`);
                html += `</tr>`;

                // UFCF Row (Hist blank)
                html += `<tr class="bg-cyan-900/10 font-bold text-cyan-400"><td class="pl-2">UFCF</td>`;
                hist.forEach(h => html += `<td class="text-right text-gray-600">-</td>`);
                proj.forEach(p => html += `<td class="text-right">${this.fmt(p.ufcf)}</td>`);
                html += `</tr>`;

                tbody.innerHTML = html;

                // 5. Update Chart
                this.updateChart(hist, proj);
            }

            updateChart(hist, proj) {
                const ctx = this.root.querySelector('.chart-dcf').getContext('2d');
                if(this.chart) this.chart.destroy();

                const labels = [...hist.map(h => `Y${h.yr}`), ...proj.map(p => `Y${p.yr}`)];
                const dataEbitda = [...hist.map(h => h.ebitda), ...proj.map(p => p.ebitda)];

                // UFCF only exists for projection, pad history with null or 0
                const dataUfcf = [...hist.map(h => null), ...proj.map(p => p.ufcf)];

                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, 'rgba(0, 240, 255, 0.5)');
                gradient.addColorStop(1, 'rgba(0, 240, 255, 0)');

                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'EBITDA',
                                data: dataEbitda,
                                borderColor: '#94a3b8',
                                borderDash: [5,5],
                                borderWidth: 2,
                                tension: 0.3
                            },
                            {
                                label: 'Projected UFCF',
                                data: dataUfcf,
                                borderColor: '#00f0ff',
                                backgroundColor: gradient,
                                fill: true,
                                borderWidth: 2,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#cbd5e1' } } },
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b' } },
                            x: { grid: { display: false }, ticks: { color: '#64748b' } }
                        }
                    }
                });
            }

            exportCSV() {
                // Simplified export logic
                alert("Export generated locally.");
            }
        }

        /**
         * Market Radar Logic
         */
        class MarketApp {
            constructor(root) {
                this.root = root;
                this.initChart();
            }
            initChart() {
                const ctx = this.root.querySelector('.market-chart').getContext('2d');
                // Dummy Data for visual
                const dataPoints = Array.from({length: 50}, (_, i) => 100 + Math.random() * 20 + i);
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 50}, (_, i) => i),
                        datasets: [{
                            label: 'Market Index',
                            data: dataPoints,
                            borderColor: '#a855f7',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { display: false } }
                    }
                });
            }
        }

        // Auto-open Mission Control on Load
        window.onload = () => {
            setTimeout(() => WindowManager.open('mission', 'Mission Control', 800, 500), 100);
            updateClock();
        };

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        setInterval(updateClock, 1000);

    </script>
</body>
</html>
