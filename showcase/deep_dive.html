<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM v23 | Deep Dive Reports</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
    <style>
        .page-a4 {
            width: 210mm;
            min-height: 297mm;
            margin: auto;
            background: white;
            color: black;
            padding: 20mm;
            display: none; /* Hidden by default */
        }
        .print-mode body {
            background: #525659;
            overflow: auto;
        }
        .print-mode .app-layout {
            display: none;
        }
        .print-mode .page-a4 {
            display: block;
        }
        /* Chart bars */
        .chart-bar {
            transition: height 1s ease-out;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans h-screen flex flex-col overflow-hidden">
    <div class="scan-line"></div>

    <!-- Header -->
    <header class="app-layout h-16 border-b border-slate-700/50 flex items-center justify-between px-6 bg-slate-900/80 backdrop-blur-md z-50">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-slate-500 hover:text-white transition">
                <i class="fas fa-chevron-left"></i>
            </a>
            <h1 class="text-xl font-bold tracking-tight text-slate-100">DEEP DIVE <span class="text-cyan-400">EXPLORER</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="togglePrintMode()" class="px-3 py-1 text-xs border border-slate-600 rounded hover:bg-slate-800 text-slate-300 transition">
                <i class="fas fa-print mr-2"></i> Export PDF
            </button>
            <div class="relative group">
                <button class="w-8 h-8 rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center hover:border-cyan-500 transition">
                    <i class="fas fa-filter text-xs text-slate-400"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main App Layout -->
    <main class="app-layout flex-1 flex gap-4 p-4 overflow-hidden">

        <!-- Left: Report List -->
        <aside class="w-80 glass-panel flex flex-col rounded-lg overflow-hidden">
            <div class="p-4 border-b border-slate-700 bg-slate-800/50">
                <input type="text" placeholder="Search reports..." class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-cyan-500 transition">
            </div>
            <div id="report-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                <!-- Report items injected here -->
            </div>
        </aside>

        <!-- Right: Report Content -->
        <section id="report-viewer" class="flex-1 glass-panel rounded-lg overflow-y-auto p-8 relative scroll-smooth">
            <!-- Content Injected Here -->
            <div class="flex flex-col items-center justify-center h-full text-slate-500">
                <i class="fas fa-file-invoice text-4xl mb-4 opacity-50"></i>
                <p>Select a report to analyze</p>
            </div>
        </section>

    </main>

    <!-- Hidden Print Layout (A4) -->
    <div id="print-view" class="page-a4 shadow-2xl">
        <div id="print-content"></div>
    </div>

    <!-- Scripts -->
    <script src="js/mock_data.js"></script>
    <script src="js/app.js"></script>
    <script>
        const reportListEl = document.getElementById('report-list');
        const viewerEl = document.getElementById('report-viewer');
        const printContentEl = document.getElementById('print-content');

        // Init
        window.dataManager.init().then(() => {
            renderList();
            // Auto load first report
            const reports = window.dataManager.getReports();
            if(reports.length > 0) loadReport(0);
        });

        function renderList() {
            const reports = window.dataManager.getReports();
            reportListEl.innerHTML = '';

            reports.forEach((rep, index) => {
                const item = document.createElement('div');
                item.className = `p-3 rounded cursor-pointer border border-transparent hover:bg-slate-800 hover:border-slate-700 transition group`;
                item.onclick = () => loadReport(index);

                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <h3 class="font-bold text-sm text-slate-200 group-hover:text-cyan-400 line-clamp-1">${rep.title || rep.file_name}</h3>
                        <span class="text-[10px] bg-slate-800 px-1 rounded text-slate-500 border border-slate-700">${rep.date || 'N/A'}</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1 line-clamp-2">${rep.executive_summary || rep.summary || 'No summary available.'}</p>
                `;
                reportListEl.appendChild(item);
            });
        }

        function loadReport(index) {
            const rep = window.dataManager.getReports()[index];
            if (!rep) return;

            // Highlight active in list
            Array.from(reportListEl.children).forEach((el, i) => {
                if (i === index) el.classList.add('bg-slate-800', 'border-cyan-500/50');
                else el.classList.remove('bg-slate-800', 'border-cyan-500/50');
            });

            // Render Interactive View
            const contentHTML = generateReportHTML(rep);
            viewerEl.innerHTML = contentHTML;

            // Render Print View
            printContentEl.innerHTML = `
                <h1 style="font-size: 24pt; font-weight: bold; margin-bottom: 20px;">${rep.title || 'Analysis Report'}</h1>
                <div style="font-family: serif; line-height: 1.6;">
                    <p><strong>Date:</strong> ${rep.date || new Date().toISOString().split('T')[0]}</p>
                    <p><strong>Analyst:</strong> ${rep.analyst || 'Adam v23'}</p>
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ccc;">
                    ${generatePrintHTML(rep)}
                </div>
            `;

            // Initialize charts or interactions if any
            setTimeout(initCharts, 100);
        }

        function generateReportHTML(data) {
            // Helper to render sections
            const renderSection = (title, content, icon='info-circle', extraClass='') => `
                <div class="mb-8 animate-fade-in ${extraClass}">
                    <h2 class="text-lg font-bold text-cyan-400 mb-3 flex items-center gap-2 border-b border-slate-700 pb-2">
                        <i class="fas fa-${icon}"></i> ${title}
                    </h2>
                    <div class="text-sm text-slate-300 leading-relaxed space-y-4">
                        ${content}
                    </div>
                </div>
            `;

            // Dynamic Content Parsing
            let mainContent = '';

            // 1. Executive Summary
            if (data.executive_summary) {
                mainContent += renderSection("Executive Summary", `<p>${data.executive_summary}</p>`, "brain");
            } else if (data.summary) {
                mainContent += renderSection("Summary", `<p>${data.summary}</p>`, "brain");
            }

            // 2. Valuation Widget (Interactive)
            if (data.valuation || data.financial_analysis) {
                const priceTarget = data.valuation?.price_target || data.price_target || 0;
                const currentPrice = data.current_price || (priceTarget * 0.8); // Mock if missing
                const upside = ((priceTarget - currentPrice) / currentPrice * 100).toFixed(1);

                const widget = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                        <div class="glass-panel p-4 rounded-lg border border-slate-700">
                            <h3 class="text-xs uppercase text-slate-500 font-bold mb-4">Valuation Model</h3>
                            <div class="flex items-end gap-4 h-32 relative">
                                <div class="w-1/2 bg-slate-700 rounded-t relative group">
                                    <div class="absolute bottom-full mb-1 w-full text-center text-xs text-slate-400">$${currentPrice}</div>
                                    <div class="h-full w-full bg-slate-600 rounded-t flex items-end justify-center text-xs text-white/20 pb-2">Current</div>
                                </div>
                                <div class="w-1/2 bg-cyan-600 rounded-t relative group chart-bar" style="height: 0%" data-height="100%">
                                    <div class="absolute bottom-full mb-1 w-full text-center text-xs text-cyan-400 font-bold">$${priceTarget}</div>
                                    <div class="h-full w-full bg-cyan-500/20 rounded-t flex items-end justify-center text-xs text-white/20 pb-2">Target</div>
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <span class="text-2xl font-bold ${upside > 0 ? 'text-emerald-400' : 'text-red-400'}">${upside > 0 ? '+' : ''}${upside}%</span>
                                <span class="text-xs text-slate-500 block">Upside Potential</span>
                            </div>
                        </div>
                         <div class="glass-panel p-4 rounded-lg border border-slate-700">
                            <h3 class="text-xs uppercase text-slate-500 font-bold mb-4">Risk Gauge (Monte Carlo)</h3>
                            <div class="relative h-32 flex items-center justify-center">
                                <!-- Simple CSS Gauge -->
                                <div class="w-32 h-16 bg-slate-800 rounded-t-full relative overflow-hidden">
                                    <div class="absolute bottom-0 left-0 w-full h-full bg-gradient-to-r from-emerald-500 via-yellow-500 to-red-500 opacity-20"></div>
                                    <div class="absolute bottom-0 left-1/2 w-1 h-16 bg-white origin-bottom transform -rotate-45 transition-transform duration-1000" id="risk-needle"></div>
                                </div>
                                <div class="absolute bottom-0 text-center">
                                    <span class="text-xl font-bold text-slate-200">Medium</span>
                                </div>
                            </div>
                            <div class="mt-4 text-xs text-slate-400 text-center">
                                Probability of Default: <span class="text-white">2.4%</span>
                            </div>
                        </div>
                    </div>
                `;
                mainContent += renderSection("Financial Intelligence", widget, "chart-bar", "");
            }

            // 3. Generic JSON Dump (formatted) for other fields
            // Just for showcase, we pretty print analysis object if exists
            if (data.analysis) {
                 // Convert analysis object to HTML
                 let analysisHTML = '';
                 if (data.analysis.segments) {
                     analysisHTML += `<h4 class="font-bold text-white mt-2">Segments</h4><ul class="list-disc pl-5">`;
                     data.analysis.segments.forEach(seg => {
                         analysisHTML += `<li><strong class="text-cyan-300">${seg.name}</strong>: ${seg.revenue_growth || ''} growth. ${seg.highlights?.[0] || ''}</li>`;
                     });
                     analysisHTML += `</ul>`;
                 }
                 if (data.analysis.competitive_landscape) {
                     analysisHTML += `<h4 class="font-bold text-white mt-4">Competitive Landscape</h4>`;
                     for (const [key, val] of Object.entries(data.analysis.competitive_landscape)) {
                         analysisHTML += `<div class="mt-2"><span class="text-slate-400 uppercase text-xs">${key}</span>: ${val.main_competitors?.join(', ')}</div>`;
                     }
                 }
                 mainContent += renderSection("Deep Analysis", analysisHTML, "microscope");
            }

            // 4. Raw text for markdown body if any (like newsletters)
            if (data.content) {
                // Simple markdown-ish parser or just text
                 mainContent += renderSection("Content", `<pre class="whitespace-pre-wrap font-mono text-xs text-slate-400 bg-slate-900 p-4 rounded border border-slate-800">${data.content}</pre>`, "align-left");
            }


            return `
                <div class="max-w-4xl mx-auto pb-20">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-white mb-2 font-mono">${data.title || data.company_name || 'Report'}</h1>
                            <div class="flex gap-4 text-xs text-slate-500">
                                <span><i class="far fa-calendar mr-1"></i> ${data.date || 'N/A'}</span>
                                <span><i class="far fa-user mr-1"></i> ${data.analyst || 'Adam AI'}</span>
                                <span class="bg-slate-800 px-2 py-0.5 rounded border border-slate-700 text-cyan-400">${data.rating || 'NEUTRAL'}</span>
                            </div>
                        </div>
                        <img src="https://ui-avatars.com/api/?name=${(data.company || data.title || 'A').substring(0,2)}&background=0f172a&color=22d3ee&font-size=0.33" class="w-16 h-16 rounded-lg border border-slate-700 shadow-lg">
                    </div>

                    ${mainContent}

                    <div class="mt-12 pt-8 border-t border-slate-800 text-center text-xs text-slate-600">
                        <p>Generated by ADAM v23.0 Adaptive System. Confidential.</p>
                    </div>
                </div>
            `;
        }

        function generatePrintHTML(data) {
            // Simplified plain HTML for print
            let html = `<h3>Executive Summary</h3><p>${data.executive_summary || data.summary || data.content || ''}</p>`;
            if (data.analysis) {
                 html += `<h3>Analysis Details</h3><pre>${JSON.stringify(data.analysis, null, 2)}</pre>`;
            }
            return html;
        }

        function initCharts() {
            // Animate bars
            document.querySelectorAll('.chart-bar').forEach(el => {
                setTimeout(() => {
                    el.style.height = el.dataset.height;
                }, 100);
            });

            // Animate needle
            const needle = document.getElementById('risk-needle');
            if (needle) {
                // Random angle for demo
                const angle = Math.floor(Math.random() * 180) - 90;
                setTimeout(() => {
                    needle.style.transform = `rotate(${angle}deg)`;
                }, 100);
            }
        }

        function togglePrintMode() {
            document.body.classList.toggle('print-mode');
        }
    </script>
</body>
</html>
