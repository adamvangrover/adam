<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM v23.5 | Deep Dive Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* --- Core Theme Overrides --- */
        body { background-color: #0f172a; font-family: 'Inter', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* CRT Scanline */
        .scan-line {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(to bottom, rgba(16, 185, 129, 0), rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0));
            opacity: 0.1; animation: scan 8s linear infinite; pointer-events: none; z-index: 9999;
        }
        @keyframes scan { 0% { top: -10%; } 100% { top: 110%; } }

        /* Glass Panels */
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(51, 65, 85, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }

        /* Widgets & Tabs */
        .phase-widget { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .phase-widget:hover {
            border-color: rgba(56, 189, 248, 0.5);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.1);
        }
        .tab-active { border-bottom: 2px solid #22d3ee; color: #22d3ee; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #94a3b8; }
        .tab-inactive:hover { color: #cbd5e1; }
        
        .chart-bar-fill { transition: width 1.5s ease-out; }
        
        /* Print Styles */
        @media print {
            body { background: white !important; color: black !important; }
            .glass-panel { background: white !important; border: 1px solid #ccc !important; box-shadow: none !important; }
            .hidden-print { display: none !important; }
            .text-white, .text-slate-200, .text-slate-300 { color: black !important; }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-200">
    <div class="scan-line hidden-print"></div>

    <header class="h-16 border-b border-slate-700/50 flex items-center justify-between px-6 bg-[#0f172a]/90 backdrop-blur-md z-40 shrink-0 hidden-print">
        <div class="flex items-center gap-4">
            <a href="index.html" class="text-slate-400 hover:text-white transition"><i class="fas fa-arrow-left"></i></a>
            <h1 class="text-xl font-bold tracking-tight mono">ADAM <span class="text-cyan-400">v23.5</span> <span class="text-slate-500 font-normal">| Deep Dive Explorer</span></h1>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="window.print()" class="px-3 py-1.5 bg-slate-800 border border-slate-600 rounded text-xs hover:bg-slate-700 transition flex items-center gap-2">
                <i class="fas fa-print"></i> PDF Export
            </button>
        </div>
    </header>

    <main class="flex-1 p-6 grid grid-cols-12 gap-6 overflow-hidden h-full">

        <aside class="col-span-12 lg:col-span-3 glass-panel rounded-lg flex flex-col h-full hidden-print">
            <div class="p-4 border-b border-slate-700/50 bg-slate-800/30">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Analysis Reports</h3>
                <div class="relative">
                    <input type="text" id="report-search" placeholder="Search Ticker / Report..." class="w-full bg-slate-900 border border-slate-700 rounded p-2 pl-8 text-xs text-white focus:outline-none focus:border-cyan-500 transition font-mono">
                    <i class="fas fa-search absolute left-2.5 top-2.5 text-slate-500 text-xs"></i>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="report-list">
                </div>
        </aside>

        <section class="col-span-12 lg:col-span-9 flex flex-col h-full overflow-hidden relative">
            
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 z-10 bg-slate-900/50 glass-panel rounded-lg">
                <i class="fas fa-microscope text-6xl mb-4 opacity-20 text-cyan-500"></i>
                <p class="font-mono text-sm">Select a report to initialize Deep Dive Protocol.</p>
            </div>

            <div id="report-content" class="flex flex-col h-full hidden">
                
                <div class="glass-panel rounded-t-lg p-6 pb-0 mb-1 border-b-0 border-slate-700 shrink-0">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <div class="flex items-center gap-3">
                                <h1 class="text-3xl font-bold text-white font-mono" id="r-title">--</h1>
                                <span class="px-2 py-0.5 rounded bg-slate-800 text-slate-300 text-xs border border-slate-600 font-mono" id="r-type">EQUITY_ANALYSIS</span>
                            </div>
                            <p class="text-slate-400 text-xs mt-1 font-mono" id="r-meta">--</p>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500 uppercase tracking-wider mb-1">Conviction</div>
                            <div class="text-2xl font-bold text-emerald-400 font-mono" id="r-conviction">--</div>
                        </div>
                    </div>

                    <div class="flex space-x-6 text-xs font-bold font-mono">
                        <button class="pb-3 tab-active transition focus:outline-none" onclick="switchTab('overview')">OVERVIEW</button>
                        <button class="pb-3 tab-inactive transition focus:outline-none" onclick="switchTab('valuation')">VALUATION</button>
                        <button class="pb-3 tab-inactive transition focus:outline-none" onclick="switchTab('risk')">RISK & SIM</button>
                        <button class="pb-3 tab-inactive transition focus:outline-none" onclick="switchTab('snc')">CREDIT / SNC</button>
                    </div>
                </div>

                <div class="glass-panel rounded-b-lg flex-1 p-6 overflow-y-auto border-t-0 border-slate-700 bg-slate-900/50 custom-scrollbar">

                    <div id="tab-overview" class="tab-content space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="glass-panel p-4 rounded border border-slate-700/50 bg-slate-800/20">
                                <div class="text-slate-400 text-[10px] uppercase mb-1 font-mono">Adam Rating</div>
                                <div class="text-xl text-emerald-400 font-bold tracking-tight" id="metric-rating">--</div>
                            </div>
                            <div class="glass-panel p-4 rounded border border-slate-700/50 bg-slate-800/20">
                                <div class="text-slate-400 text-[10px] uppercase mb-1 font-mono">Target Price</div>
                                <div class="text-xl text-white font-mono" id="metric-target">--</div>
                            </div>
                            <div class="glass-panel p-4 rounded border border-slate-700/50 bg-slate-800/20">
                                <div class="text-slate-400 text-[10px] uppercase mb-1 font-mono">Risk Score</div>
                                <div class="text-xl text-white font-mono" id="metric-risk">--</div>
                            </div>
                        </div>

                        <div class="p-5 bg-slate-800/30 border border-slate-700/50 rounded-lg">
                            <h3 class="text-sm text-cyan-400 font-bold mb-3 border-b border-slate-700/50 pb-2 uppercase tracking-wider">Executive Summary</h3>
                            <p class="text-slate-300 leading-relaxed text-sm font-light" id="r-summary">Loading...</p>
                        </div>
                    </div>

                    <div id="tab-valuation" class="tab-content hidden space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="glass-panel p-6 rounded-lg border border-slate-700/50">
                                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Intrinsic Valuation (DCF)</h3>
                                <div class="space-y-6">
                                    <div>
                                        <div class="flex justify-between text-xs mb-2 font-mono">
                                            <span class="text-slate-400">Intrinsic Value</span>
                                            <span id="val-intrinsic" class="font-bold text-emerald-400">$0.00</span>
                                        </div>
                                        <div class="w-full bg-slate-800 h-3 rounded-full overflow-hidden shadow-inner">
                                            <div id="bar-intrinsic" class="bg-gradient-to-r from-emerald-600 to-emerald-400 h-full chart-bar-fill rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between text-xs mb-2 font-mono">
                                            <span class="text-slate-400">Current Market Price</span>
                                            <span id="val-market" class="font-bold text-blue-400">$0.00</span>
                                        </div>
                                        <div class="w-full bg-slate-800 h-3 rounded-full overflow-hidden shadow-inner">
                                            <div id="bar-market" class="bg-gradient-to-r from-blue-600 to-blue-400 h-full chart-bar-fill rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div id="val-divergence" class="mt-6 text-xs text-center font-mono py-2 bg-slate-800/50 rounded text-slate-300">
                                    --
                                </div>
                            </div>
                            
                            <div class="glass-panel p-6 rounded-lg border border-slate-700/50">
                                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Relative Valuation</h3>
                                <div class="space-y-3 text-sm" id="val-multiples">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-risk" class="tab-content hidden space-y-6">
                        <div class="flex flex-col lg:flex-row gap-6">
                            <div class="glass-panel p-6 rounded-lg border border-slate-700/50 flex-1 flex flex-col items-center justify-center min-h-[250px]">
                                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 w-full text-left">Default Probability (1yr)</h3>
                                <div class="relative w-48 h-24 mt-4">
                                    <svg viewBox="0 0 200 100" class="w-full h-full overflow-visible">
                                        <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#1e293b" stroke-width="20" stroke-linecap="round" />
                                        <path id="risk-gauge-arc" d="M 20 100 A 80 80 0 0 1 20 100" fill="none" stroke="#ef4444" stroke-width="20" stroke-linecap="round" style="transition: stroke-dasharray 1s ease;"/>
                                    </svg>
                                    <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-4 text-center">
                                        <div class="text-3xl font-bold font-mono text-white" id="risk-score">0%</div>
                                        <div class="text-[10px] text-slate-500 uppercase tracking-widest mt-1">Monte Carlo</div>
                                    </div>
                                </div>
                            </div>

                            <div class="glass-panel p-6 rounded-lg border border-slate-700/50 flex-[2]">
                                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Stress Test Scenarios</h3>
                                <div class="space-y-3" id="risk-scenarios">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-snc" class="tab-content hidden">
                        <div class="grid grid-cols-1 gap-6">
                            <div class="p-4 bg-emerald-900/20 border border-emerald-500/30 rounded-lg flex justify-between items-center" id="snc-banner">
                                <div>
                                    <h3 class="text-emerald-400 font-bold text-sm">Shared National Credit (SNC) Status</h3>
                                    <p class="text-xs text-slate-400 mt-1">Regulatory Rating Assessment</p>
                                </div>
                                <div class="text-2xl font-bold text-white font-mono tracking-widest" id="snc-rating">PASS</div>
                            </div>
                            
                            <div class="glass-panel p-6 rounded-lg border border-slate-700/50">
                                <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">Facility Ratings</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left text-xs font-mono">
                                        <thead class="text-slate-500 border-b border-slate-700">
                                            <tr>
                                                <th class="pb-2">Facility ID</th>
                                                <th class="pb-2">Type</th>
                                                <th class="pb-2">Commitment</th>
                                                <th class="pb-2">Rating</th>
                                            </tr>
                                        </thead>
                                        <tbody class="text-slate-300 divide-y divide-slate-800" id="snc-facilities">
                                            </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <script src="js/mock_data.js"></script>
    <script src="js/app.js"></script>
    <script src="js/nav.js"></script>
    <script>
        // -- STATE --
        let reports = [];
        const FALLBACK_REPORTS = [
            {
                id: 1, title: "Nvidia Corp (NVDA) Deep Dive", date: "2025-10-24",
                v23_knowledge_graph: {
                    meta: { target: "NVDA" },
                    nodes: {
                        entity_ecosystem: { management_assessment: { narrative: "Dominant AI infrastructure player. Software moat expanding via CUDA." } },
                        equity_analysis: { valuation_engine: { dcf_model: { intrinsic_share_price: 1150.00, current_price_divergence: "Undervalued by 12%" }, multiples_analysis: { current_pe: 45.2, verdict: "Premium justified by growth" } } },
                        simulation_engine: { monte_carlo_default_prob: 0.02, quantum_scenarios: [{name: "Supply Chain Shock", impact: "-15% Revenue"}, {name: "AI Regulation", impact: "-5% Revenue"}] },
                        credit_analysis: { snc_rating_model: { overall_borrower_rating: "Pass", facilities: [{id: "Revolver 2028", type: "Revolving", commitment: "$3.0B", regulatory_rating: "Pass"}] } },
                        strategic_synthesis: { final_verdict: { recommendation: "BUY", conviction_level: 9, rationale_summary: "Secular AI tailwinds remain intact. Valuation reasonable given PEG ratio." } }
                    }
                },
                market_price: 1020.50
            },
            {
                id: 2, title: "Tesla Inc (TSLA) Credit Review", date: "2025-10-22",
                v23_knowledge_graph: {
                    meta: { target: "TSLA" },
                    nodes: {
                        entity_ecosystem: { management_assessment: { narrative: "Margin compression in auto segment. Energy storage growth is the key offset." } },
                        equity_analysis: { valuation_engine: { dcf_model: { intrinsic_share_price: 180.00, current_price_divergence: "Overvalued by 20%" }, multiples_analysis: { current_pe: 65.0, verdict: "Rich" } } },
                        simulation_engine: { monte_carlo_default_prob: 0.08, quantum_scenarios: [{name: "Rate Hike +100bps", impact: "-12% Demand"}, {name: "FSD Approval", impact: "+40% Market Cap"}] },
                        credit_analysis: { snc_rating_model: { overall_borrower_rating: "Pass", facilities: [{id: "Term Loan A", type: "Term", commitment: "$1.5B", regulatory_rating: "Pass"}] } },
                        strategic_synthesis: { final_verdict: { recommendation: "HOLD", conviction_level: 6, rationale_summary: "Execution risk high on robotaxi rollout. Balance sheet remains healthy." } }
                    }
                },
                market_price: 215.00
            }
        ];

        // -- INIT --
        document.addEventListener('DOMContentLoaded', async () => {
            if (window.dataManager) {
                try {
                    await window.dataManager.init();
                    reports = window.dataManager.getReports();
                } catch(e) { reports = FALLBACK_REPORTS; }
            } else {
                reports = FALLBACK_REPORTS;
            }
            if(!reports || reports.length === 0) reports = FALLBACK_REPORTS;

            renderSidebar(reports);
            
            // Search Logic
            document.getElementById('report-search').addEventListener('keyup', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = reports.filter(r => r.title.toLowerCase().includes(term));
                renderSidebar(filtered);
            });
        });

        function renderSidebar(list) {
            const container = document.getElementById('report-list');
            container.innerHTML = '';
            
            list.forEach(r => {
                const div = document.createElement('div');
                div.className = "p-3 rounded-lg hover:bg-slate-800 cursor-pointer transition border border-transparent hover:border-slate-700 group mb-1";
                div.onclick = () => loadReport(r);
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="font-bold text-xs text-slate-300 group-hover:text-cyan-400 transition truncate w-3/4">${r.title}</span>
                        <span class="text-[9px] px-1.5 py-0.5 bg-slate-900 rounded text-slate-500 font-mono">V23</span>
                    </div>
                    <div class="text-[10px] text-slate-500 font-mono">${r.date || 'N/A'}</div>
                `;
                container.appendChild(div);
            });
        }

        function loadReport(report) {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('report-content').classList.remove('hidden');

            const kg = report.v23_knowledge_graph || {};
            const nodes = kg.nodes || {};
            
            // Header
            document.getElementById('r-title').textContent = report.title;
            document.getElementById('r-meta').textContent = `Target: ${kg.meta?.target || 'N/A'} | ID: ${report.id}`;
            
            const verdict = nodes.strategic_synthesis?.final_verdict || {};
            const rec = verdict.recommendation || "NEUTRAL";
            document.getElementById('r-conviction').textContent = `${rec} (${verdict.conviction_level || 5}/10)`;
            document.getElementById('r-conviction').className = `text-2xl font-bold font-mono ${rec === 'BUY' ? 'text-emerald-400' : (rec === 'SELL' ? 'text-red-500' : 'text-amber-400')}`;

            // Overview
            document.getElementById('r-summary').textContent = nodes.entity_ecosystem?.management_assessment?.narrative || "No summary available.";
            document.getElementById('metric-rating').textContent = rec;
            
            const target = nodes.equity_analysis?.valuation_engine?.price_targets?.base_case;
            document.getElementById('metric-target').textContent = target ? `$${target}` : "N/A";
            
            const pd = nodes.simulation_engine?.monte_carlo_default_prob || 0;
            document.getElementById('metric-risk').textContent = (pd * 100).toFixed(2) + "%";

            // Valuation
            const dcf = nodes.equity_analysis?.valuation_engine?.dcf_model || {};
            const intrinsic = dcf.intrinsic_share_price || 0;
            const market = report.market_price || dcf.market_price || 100;
            const maxVal = Math.max(intrinsic, market) * 1.2;

            document.getElementById('val-intrinsic').textContent = `$${intrinsic.toFixed(2)}`;
            document.getElementById('val-market').textContent = `$${market.toFixed(2)}`;
            
            // Animate Bars
            setTimeout(() => {
                document.getElementById('bar-intrinsic').style.width = `${(intrinsic / maxVal) * 100}%`;
                document.getElementById('bar-market').style.width = `${(market / maxVal) * 100}%`;
            }, 100);

            document.getElementById('val-divergence').textContent = dcf.current_price_divergence || "Calculating divergence...";

            // Risk Gauge
            document.getElementById('risk-score').textContent = (pd * 100).toFixed(1) + "%";
            document.getElementById('risk-score').style.color = pd > 0.1 ? '#ef4444' : '#10b981';
            
            // Gauge Arc Math
            const angleRad = Math.PI * (1 - Math.min(pd * 5, 1)); // Scale PD for visual effect
            const endX = 100 + 80 * Math.cos(angleRad);
            const endY = 100 - 80 * Math.sin(angleRad);
            document.getElementById('risk-gauge-arc').setAttribute('d', `M 20 100 A 80 80 0 0 1 ${endX} ${endY}`);
            document.getElementById('risk-gauge-arc').setAttribute('stroke', pd > 0.1 ? '#ef4444' : '#10b981');

            // Scenarios
            const scenarios = nodes.simulation_engine?.quantum_scenarios || [];
            document.getElementById('risk-scenarios').innerHTML = scenarios.map(s => `
                <div class="flex justify-between items-center p-2 bg-slate-800/30 rounded border border-slate-700/50">
                    <span class="text-xs text-slate-300">${s.name}</span>
                    <span class="text-xs font-mono ${s.impact.includes('-') ? 'text-red-400' : 'text-emerald-400'}">${s.impact}</span>
                </div>
            `).join('');

            // SNC
            const snc = nodes.credit_analysis?.snc_rating_model || {};
            document.getElementById('snc-rating').textContent = snc.overall_borrower_rating || "N/A";
            const sncBanner = document.getElementById('snc-banner');
            if(snc.overall_borrower_rating === 'Pass') {
                sncBanner.className = "p-4 bg-emerald-900/20 border border-emerald-500/30 rounded-lg flex justify-between items-center";
            } else {
                sncBanner.className = "p-4 bg-red-900/20 border border-red-500/30 rounded-lg flex justify-between items-center";
            }

            document.getElementById('snc-facilities').innerHTML = (snc.facilities || []).map(f => `
                <tr>
                    <td class="py-2">${f.id}</td>
                    <td class="py-2 text-slate-500">${f.type || 'N/A'}</td>
                    <td class="py-2 font-mono">${f.commitment || 'N/A'}</td>
                    <td class="py-2"><span class="px-1.5 py-0.5 rounded text-[10px] ${f.regulatory_rating === 'Pass' ? 'bg-emerald-900/50 text-emerald-400' : 'bg-red-900/50 text-red-400'}">${f.regulatory_rating}</span></td>
                </tr>
            `).join('');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('button[onclick^="switchTab"]').forEach(btn => {
                if(btn.getAttribute('onclick').includes(tab)) {
                    btn.className = "pb-3 tab-active transition focus:outline-none";
                } else {
                    btn.className = "pb-3 tab-inactive transition focus:outline-none";
                }
            });
        }
    </script>
</body>
</html>